{% extends 'base.html' %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'mold:mold_list' %}">KalÄ±plarÄ±m</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'mold:mold_detail' mold.pk %}">{{ mold.patient_name }} {{ mold.patient_surname }}</a></li>
                    <li class="breadcrumb-item active">Fiziksel GÃ¶nderim DetaylarÄ±</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row">
        <!-- Kargo Adresi -->
        <div class="col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-map-marker-alt me-2"></i>Kargo GÃ¶nderim Adresi
                    </h5>
                </div>
                <div class="card-body">
                    {% if producer %}
                        <div class="alert alert-success">
                            <h6><i class="fas fa-check-circle me-2"></i>Ãœretici Merkez Bilgileri</h6>
                            <address class="mb-0">
                                <strong>{{ producer.company_name }}</strong><br>
                                {% if producer.address %}
                                    {{ producer.address|linebreaks }}
                                {% else %}
                                    <em class="text-muted">Adres bilgisi henÃ¼z eklenmemiÅŸ</em><br>
                                {% endif %}
                                
                                {% if producer.phone %}
                                    <i class="fas fa-phone me-1"></i>{{ producer.phone }}<br>
                                {% endif %}
                                
                                {% if producer.user.email %}
                                    <i class="fas fa-envelope me-1"></i>{{ producer.user.email }}<br>
                                {% endif %}
                                
                                {% if producer.contact_person %}
                                    <i class="fas fa-user me-1"></i>{{ producer.contact_person }}
                                {% endif %}
                            </address>
                        </div>
                        
                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle me-2"></i>GÃ¶nderim TalimatlarÄ±</h6>
                            <ul class="mb-0">
                                <li>KalÄ±bÄ±nÄ±zÄ± saÄŸlam bir kutu iÃ§inde paketleyiniz</li>
                                <li>Paketin Ã¼zerine sipariÅŸ numarasÄ±nÄ± yazÄ±nÄ±z: <strong>{{ producer_order.order_number }}</strong></li>
                                <li>Hasta bilgilerini paketin iÃ§ine koyunuz</li>
                                <li>KÄ±rÄ±labilir etiketini unutmayÄ±nÄ±z</li>
                                <li>Kargo takip numarasÄ±nÄ± aldÄ±ktan sonra sisteme giriniz</li>
                            </ul>
                        </div>
                    {% else %}
                        <div class="alert alert-warning">
                            <h6><i class="fas fa-exclamation-triangle me-2"></i>Ãœretici Bilgisi BulunamadÄ±</h6>
                            <p class="mb-0">Bu kalÄ±p iÃ§in henÃ¼z bir Ã¼retici atanmamÄ±ÅŸ. LÃ¼tfen yÃ¶netici ile iletiÅŸime geÃ§in.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- KalÄ±p ve Kargo Bilgileri -->
        <div class="col-md-6">
            <!-- KARGO ETÄ°KETÄ° ÃœRETÄ°MÄ° -->
            {% if cargo_shipment %}
            <div class="card border-0 shadow-sm mb-4 border-primary" style="border-width: 2px !important;">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-tag me-2"></i>
                        ðŸšš KARGO ETÄ°KETÄ° ÃœRETÄ°MÄ°
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Kargo GÃ¶nderisi HazÄ±r!</strong><br>
                        KalÄ±p iÃ§in kargo gÃ¶nderisi baÅŸarÄ±yla oluÅŸturulmuÅŸtur.
                    </div>

                    {% if cargo_shipment.label_generated %}
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            Etiket oluÅŸturulmuÅŸ ({{ cargo_shipment.label_print_count }} kez yazdÄ±rÄ±lmÄ±ÅŸ)
                        </div>

                        <div class="d-grid gap-2">
                            {% if cargo_shipment.label_file %}
                                <a href="{{ cargo_shipment.label_file.url }}"
                                   target="_blank"
                                   class="btn btn-outline-primary">
                                    <i class="fas fa-eye me-2"></i>Etiketi GÃ¶rÃ¼ntÃ¼le
                                </a>
                            {% endif %}

                            <button class="btn btn-success"
                                    onclick="printLabel({{ cargo_shipment.id }})">
                                <i class="fas fa-print me-2"></i>YazdÄ±r
                            </button>

                            <button class="btn btn-outline-secondary"
                                    onclick="regenerateLabel({{ cargo_shipment.id }})">
                                <i class="fas fa-sync me-2"></i>Yeniden OluÅŸtur
                            </button>
                        </div>
                    {% else %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            HenÃ¼z etiket oluÅŸturulmamÄ±ÅŸ
                        </div>

                        <div class="d-grid gap-2">
                            <button class="btn btn-primary"
                                    onclick="generateLabel({{ cargo_shipment.id }}, 'pdf')">
                                <i class="fas fa-file-pdf me-2"></i>PDF Etiket OluÅŸtur
                            </button>

                            <button class="btn btn-outline-primary"
                                    onclick="generateLabel({{ cargo_shipment.id }}, 'thermal')">
                                <i class="fas fa-receipt me-2"></i>Termal Etiket OluÅŸtur
                            </button>
                        </div>
                    {% endif %}

                    <hr class="my-3">

                    <div class="small text-muted">
                        <strong>Etiket TÃ¼rÃ¼:</strong> {{ cargo_shipment.get_label_type_display|default:"HenÃ¼z oluÅŸturulmadÄ±" }}<br>
                        {% if cargo_shipment.label_generated_at %}
                            <strong>OluÅŸturulma:</strong> {{ cargo_shipment.label_generated_at|date:"d.m.Y H:i" }}
                        {% endif %}
                    </div>
                </div>
            </div>
            {% else %}
            <!-- Kargo GÃ¶nderisi OluÅŸtur (fatura beklemeden) -->
            <div class="card border-0 shadow-sm mb-4 border-warning" style="border-width: 2px !important;">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-plus me-2"></i>
                        ðŸ“¦ KARGO GÃ–NDERÄ°SÄ° OLUÅžTUR
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Fatura gerekmiyor. KalÄ±p tamamlanÄ±r tamamlanmaz kargo gÃ¶nderisi oluÅŸturup etiket Ã¼retebilirsiniz.
                    </div>

                    <div class="d-grid gap-2">
                        {% if mold.status == 'completed' %}
                        <a href="{% url 'core:create_cargo_shipment_from_mold' mold.pk %}" class="btn btn-success">
                            <i class="fas fa-shipping-fast me-2"></i>Kargo GÃ¶nderisi OluÅŸtur
                        </a>
                        {% else %}
                        <button class="btn btn-outline-secondary" disabled>
                            <i class="fas fa-clock me-2"></i>KalÄ±p Ãœretimi Bekleniyor...
                        </button>
                        {% endif %}
                    </div>

                    <hr class="my-3">

                    <div class="small text-muted">
                        <strong>KalÄ±p Durumu:</strong> {{ mold.get_status_display }}<br>
                        <strong>Not:</strong> Kargo gÃ¶nderisi oluÅŸturduktan sonra etiket Ã¼retimi aktif olacaktÄ±r.
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0">
                    <h5 class="mb-0">
                        <i class="fas fa-shipping-fast me-2"></i>Kargo Durumu
                    </h5>
                </div>
                <div class="card-body">
                    <!-- KalÄ±p Bilgileri -->
                    <div class="mb-4">
                        <h6>KalÄ±p Bilgileri</h6>
                        <div class="row">
                            <div class="col-6"><strong>Hasta:</strong></div>
                            <div class="col-6">{{ mold.patient_name }} {{ mold.patient_surname }}</div>
                            
                            <div class="col-6"><strong>KalÄ±p Tipi:</strong></div>
                            <div class="col-6">{{ mold.get_mold_type_display }}</div>
                            
                            <div class="col-6"><strong>Vent Ã‡apÄ±:</strong></div>
                            <div class="col-6">{{ mold.vent_diameter }} mm</div>
                            
                            <div class="col-6"><strong>Ã–ncelik:</strong></div>
                            <div class="col-6">
                                <span class="badge bg-{{ mold.get_priority_color }}">{{ mold.get_priority_display }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Kargo Durumu -->
                    <div class="mb-4">
                        <h6>Kargo Durumu</h6>
                        <div class="progress mb-2" style="height: 25px;">
                            {% if mold.shipment_status == 'not_shipped' %}
                                <div class="progress-bar bg-secondary" style="width: 25%">HazÄ±rlanÄ±yor</div>
                            {% elif mold.shipment_status == 'shipped' %}
                                <div class="progress-bar bg-info" style="width: 50%">Kargoda</div>
                            {% elif mold.shipment_status == 'in_transit' %}
                                <div class="progress-bar bg-warning" style="width: 75%">Yolda</div>
                            {% elif mold.shipment_status == 'delivered_to_producer' %}
                                <div class="progress-bar bg-success" style="width: 100%">Teslim Edildi</div>
                            {% elif mold.shipment_status == 'returned' %}
                                <div class="progress-bar bg-danger" style="width: 100%">Ä°ade Edildi</div>
                            {% endif %}
                        </div>
                        <div class="text-center">
                            <span class="badge bg-{{ mold.get_shipment_status_color }} fs-6">
                                {{ mold.get_shipment_status_display_custom }}
                            </span>
                        </div>
                    </div>

                    <!-- Kargo DetaylarÄ± -->
                    {% if mold.tracking_number or mold.carrier_company %}
                    <div class="mb-4">
                        <h6>Kargo DetaylarÄ±</h6>
                        <div class="list-group list-group-flush">
                            {% if mold.carrier_company %}
                            <div class="list-group-item d-flex justify-content-between px-0">
                                <strong>Kargo FirmasÄ±:</strong>
                                <span>{{ mold.get_carrier_company_display }}</span>
                            </div>
                            {% endif %}
                            
                            {% if mold.tracking_number %}
                            <div class="list-group-item d-flex justify-content-between px-0">
                                <strong>Takip NumarasÄ±:</strong>
                                <span class="font-monospace">{{ mold.tracking_number }}</span>
                            </div>
                            {% endif %}
                            
                            {% if mold.shipment_date %}
                            <div class="list-group-item d-flex justify-content-between px-0">
                                <strong>GÃ¶nderim Tarihi:</strong>
                                <span>{{ mold.shipment_date|date:"d.m.Y H:i" }}</span>
                            </div>
                            {% endif %}
                            
                            {% if mold.estimated_delivery %}
                            <div class="list-group-item d-flex justify-content-between px-0">
                                <strong>Tahmini Teslimat:</strong>
                                <span>{{ mold.estimated_delivery|date:"d.m.Y" }}</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Eylem ButonlarÄ± -->
                    <div class="d-grid gap-2">
                        <a href="{% url 'mold:update_tracking' mold.pk %}" class="btn btn-primary">
                            <i class="fas fa-edit me-2"></i>Kargo Bilgilerini GÃ¼ncelle
                        </a>
                        <a href="{% url 'mold:mold_detail' mold.pk %}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>KalÄ±p DetayÄ±na DÃ¶n
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notlar -->
    {% if mold.notes or mold.special_instructions or mold.shipment_notes %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0">
                    <h5 class="mb-0">
                        <i class="fas fa-sticky-note me-2"></i>Notlar ve Talimatlar
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% if mold.notes %}
                        <div class="col-md-4">
                            <h6>Genel Notlar</h6>
                            <p class="text-muted">{{ mold.notes|linebreaks }}</p>
                        </div>
                        {% endif %}
                        
                        {% if mold.special_instructions %}
                        <div class="col-md-4">
                            <h6>Ã–zel Talimatlar</h6>
                            <p class="text-muted">{{ mold.special_instructions|linebreaks }}</p>
                        </div>
                        {% endif %}
                        
                        {% if mold.shipment_notes %}
                        <div class="col-md-4">
                            <h6>Kargo NotlarÄ±</h6>
                            <p class="text-muted">{{ mold.shipment_notes|linebreaks }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
// Etiket iÅŸlemleri
function generateLabel(shipmentId, labelType) {
    if (!confirm('Etiket oluÅŸturmak istediÄŸinizden emin misiniz?')) {
        return;
    }

    const button = event ? event.target.closest('button') : null;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>OluÅŸturuluyor...';
    button.disabled = true;

    fetch(`/cargo/shipment/${shipmentId}/generate-label/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCsrfToken()
        },
        body: `label_type=${labelType}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Etiket baÅŸarÄ±yla oluÅŸturuldu!');
            location.reload();
        } else {
            alert('Hata: ' + (data.message || 'Etiket oluÅŸturulamadÄ±'));
            button.innerHTML = originalText;
            button.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Bir hata oluÅŸtu');
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function regenerateLabel(shipmentId) {
    if (!confirm('Etiketi yeniden oluÅŸturmak istediÄŸinizden emin misiniz?')) {
        return;
    }

    const button = event ? event.target.closest('button') : null;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Yeniden OluÅŸturuluyor...';
    button.disabled = true;

    fetch(`/cargo/shipment/${shipmentId}/generate-label/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCsrfToken()
        },
        body: 'label_type=pdf'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Etiket baÅŸarÄ±yla yeniden oluÅŸturuldu!');
            location.reload();
        } else {
            alert('Hata: ' + (data.message || 'Etiket yeniden oluÅŸturulamadÄ±'));
            button.innerHTML = originalText;
            button.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Bir hata oluÅŸtu');
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function printLabel(shipmentId) {
    const button = event ? event.target.closest('button') : null;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>YazdÄ±rÄ±lÄ±yor...';
    button.disabled = true;

    fetch(`/cargo/shipment/${shipmentId}/print-label/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Etiket dosyasÄ±nÄ± yeni sekmede aÃ§
            if (data.file_url) {
                window.open(data.file_url, '_blank');
            }
            alert('Etiket yazdÄ±rma iÃ§in hazÄ±r!');
            button.innerHTML = originalText;
            button.disabled = false;
        } else {
            alert('Hata: ' + (data.message || 'YazdÄ±rma iÅŸlemi baÅŸarÄ±sÄ±z'));
            button.innerHTML = originalText;
            button.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Bir hata oluÅŸtu');
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function getCsrfToken() {
    const token = document.querySelector('[name=csrfmiddlewaretoken]');
    return token ? token.value : '';
}
</script>
{% endblock %} 