{% extends 'base.html' %}
{% load static %}
{% load moldpark_extras %}

{% block title %}
{% if mold %}Kalıp Düzenle{% else %}Yeni Kalıp Oluştur{% endif %} - MoldPark
{% endblock %}

{% block extra_css %}
<style>
:root {
    --primary: #4f46e5;
    --primary-light: #6366f1;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --gray-50: #f9fafb;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-300: #d1d5db;
    --gray-500: #6b7280;
    --gray-700: #374151;
    --gray-800: #1f2937;
}

.form-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 2rem 1rem;
}

.form-header {
    text-align: center;
    margin-bottom: 3rem;
}

.form-title {
    font-size: 2rem;
    font-weight: 700;
    color: var(--gray-800);
    margin-bottom: 0.5rem;
}

.form-subtitle {
    color: var(--gray-500);
    font-size: 1rem;
}

.form-card {
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    margin-bottom: 2rem;
    border: 1px solid var(--gray-200);
}

.card-header {
    background: var(--gray-50);
    padding: 1.5rem;
    border-bottom: 1px solid var(--gray-200);
}

.card-header h3 {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--gray-700);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.card-body {
    padding: 2rem;
}

.form-section {
    margin-bottom: 2rem;
}

.form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 1.5rem;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: block;
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--gray-700);
    margin-bottom: 0.5rem;
}

.form-control {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid var(--gray-300);
    border-radius: 8px;
    font-size: 0.875rem;
    transition: all 0.2s ease;
    background-color: white;
}

.form-control:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    outline: none;
}

.form-control:disabled {
    background-color: var(--gray-50);
    color: var(--gray-500);
    cursor: not-allowed;
}

.form-select {
    appearance: none;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 0.5rem center;
    background-repeat: no-repeat;
    background-size: 1.5em 1.5em;
    padding-right: 2.5rem;
}

/* Radio button styles */
.radio-group {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-top: 0.5rem;
}

.radio-option {
    position: relative;
    border: 2px solid var(--gray-300);
    border-radius: 12px;
    padding: 1.5rem;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
}

.radio-option:hover {
    border-color: var(--primary-light);
    background: var(--gray-50);
}

.radio-option.selected {
    border-color: var(--primary);
    background: rgba(79, 70, 229, 0.05);
}

.radio-option input[type="radio"] {
    position: absolute;
    opacity: 0;
    width: 0;
    height: 0;
}

.radio-option-icon {
    font-size: 2rem;
    color: var(--primary);
    margin-bottom: 0.5rem;
}

.radio-option-title {
    font-weight: 600;
    color: var(--gray-800);
    margin-bottom: 0.25rem;
}

.radio-option-desc {
    font-size: 0.875rem;
    color: var(--gray-500);
}

/* File upload styles */
.file-upload-area {
    border: 2px dashed var(--gray-300);
    border-radius: 12px;
    padding: 3rem 2rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
    background: var(--gray-50);
}

.file-upload-area:hover {
    border-color: var(--primary);
    background: rgba(79, 70, 229, 0.05);
}

.file-upload-area.drag-over {
    border-color: var(--primary);
    background: rgba(79, 70, 229, 0.1);
}

.file-upload-icon {
    font-size: 3rem;
    color: var(--primary);
    margin-bottom: 1rem;
}

.file-upload-text {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--gray-700);
    margin-bottom: 0.5rem;
}

.file-upload-hint {
    font-size: 0.875rem;
    color: var(--gray-500);
}

.file-info {
    background: var(--success);
    color: white;
    padding: 1rem;
    border-radius: 8px;
    margin-top: 1rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

/* Action buttons */
.form-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid var(--gray-200);
}

.btn {
    padding: 0.75rem 2rem;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s ease;
    border: none;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-primary {
    background: var(--primary);
    color: white;
}

.btn-primary:hover {
    background: var(--primary-light);
    transform: translateY(-1px);
}

.btn-secondary {
    background: white;
    color: var(--gray-700);
    border: 2px solid var(--gray-300);
}

.btn-secondary:hover {
    background: var(--gray-50);
    border-color: var(--gray-400);
}

/* Alert styles */
.alert {
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
    border: 1px solid;
}

.alert-warning {
    background: #fef3cd;
    border-color: #facc15;
    color: #92400e;
}

.alert-info {
    background: #dbeafe;
    border-color: #60a5fa;
    color: #1e40af;
}

/* Responsive */
@media (max-width: 768px) {
    .form-container {
        padding: 1rem;
    }
    
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .radio-group {
        grid-template-columns: 1fr;
    }
    
    .form-actions {
        flex-direction: column;
    }
    
    .btn {
        justify-content: center;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="form-container">
    <!-- Form Header -->
    <div class="form-header">
        <h1 class="form-title">
            {% if mold %}
                Kalıp Düzenle
            {% else %}
                Yeni Kalıp Oluştur
            {% endif %}
        </h1>
        <p class="form-subtitle">
            {% if mold %}
                {{ mold.patient_name }} {{ mold.patient_surname }} için kalıp düzenleme
            {% else %}
                Kalıp siparişi oluşturmak için aşağıdaki formu doldurun
            {% endif %}
        </p>
    </div>

    <!-- Network warning -->
    {% if not active_networks %}
    <div class="alert alert-warning">
        <div class="d-flex align-items-center">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <div>
                <strong>Uyarı:</strong> Kalıp siparişi verebilmek için önce bir üretici ağına katılmanız gerekiyor.
                <a href="{% url 'center:network_management' %}" class="ms-2">Üretici Ağları</a>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Subscription info - Yeni Fiyatlandırma Sistemi -->
    {% if subscription %}
    <div class="alert alert-info border-0 shadow-sm">
        <div class="row align-items-center">
            <div class="col-md-8">
                <div class="d-flex align-items-start mb-2">
                    <i class="fas fa-info-circle me-2 mt-1"></i>
                    <div>
                        <strong>{{ subscription.plan.name }}</strong>
                        <div class="mt-2">
                            <small class="d-block text-muted">
                                <i class="fas fa-calculator me-1"></i>
                                Her kalıp için: <strong>₺{{ mold_price }}</strong> (kargo hariç)
                            </small>
                            <small class="d-block text-muted">
                                <i class="fas fa-chart-line me-1"></i>
                                Bu ay toplam: <strong>₺{{ current_month_total }}</strong>
                            </small>
                            <small class="d-block text-success mt-1">
                                <i class="fas fa-infinity me-1"></i>
                                Sınırsız kalıp üretimi - kullandıkça öde
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 text-end">
                <a href="{% url 'core:subscription_dashboard' %}" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-eye me-1"></i>
                    Detayları Gör
                </a>
            </div>
        </div>
    </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data" id="moldForm">
        {% csrf_token %}

        <!-- 1. Sipariş Türü -->
        <div class="form-card">
            <div class="card-header">
                <h3>
                    <i class="fas fa-cube"></i>
                    Sipariş Türü
                </h3>
            </div>
            <div class="card-body">
                <div class="radio-group">
                    <div class="radio-option" data-type="digital" id="option-digital">
                        <input type="radio" name="order_type" value="digital" 
                               {% if not mold or not mold.is_physical_shipment %}checked{% endif %}>
                        <div class="radio-option-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <div class="radio-option-title">Dijital Tarama</div>
                        <div class="radio-option-desc">STL/OBJ/PLY dosyası yükle</div>
                    </div>
                    <div class="radio-option" data-type="physical" id="option-physical">
                        <input type="radio" name="order_type" value="physical"
                               {% if mold and mold.is_physical_shipment %}checked{% endif %}>
                        <div class="radio-option-icon">
                            <i class="fas fa-box"></i>
                        </div>
                        <div class="radio-option-title">Fiziksel Kalıp</div>
                        <div class="radio-option-desc">Kargo ile gönderim</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. Hasta Bilgileri -->
        <div class="form-card">
            <div class="card-header">
                <h3>
                    <i class="fas fa-user"></i>
                    Hasta Bilgileri
                </h3>
            </div>
            <div class="card-body">
                <div class="form-row">
                    <div class="form-group">
                        <label for="{{ form.patient_name.id_for_label }}">{{ form.patient_name.label }}</label>
                        {{ form.patient_name|add_class:"form-control" }}
                    </div>
                    <div class="form-group">
                        <label for="{{ form.patient_surname.id_for_label }}">{{ form.patient_surname.label }}</label>
                        {{ form.patient_surname|add_class:"form-control" }}
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="{{ form.patient_age.id_for_label }}">{{ form.patient_age.label }}</label>
                        {{ form.patient_age|add_class:"form-control" }}
                    </div>
                    <div class="form-group">
                        <label for="{{ form.patient_gender.id_for_label }}">{{ form.patient_gender.label }}</label>
                        {{ form.patient_gender|add_class:"form-control form-select" }}
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. Kalıp Özellikleri -->
        <div class="form-card">
            <div class="card-header">
                <h3>
                    <i class="fas fa-sliders-h"></i>
                    Kalıp Özellikleri
                </h3>
            </div>
            <div class="card-body">
                <!-- Kulak Yönü -->
                <div class="form-section">
                    <label>{{ form.ear_side.label }}</label>
                    <div class="radio-group">
                        <div class="radio-option" data-side="right" id="side-right">
                            <input type="radio" name="ear_side" value="right"
                                   {% if form.ear_side.value == 'right' %}checked{% endif %}>
                            <div class="radio-option-icon">
                                <i class="fas fa-arrow-right"></i>
                            </div>
                            <div class="radio-option-title">Sağ Kulak</div>
                        </div>
                        <div class="radio-option" data-side="left" id="side-left">
                            <input type="radio" name="ear_side" value="left"
                                   {% if form.ear_side.value == 'left' or form.ear_side.value == None %}checked{% endif %}>
                            <div class="radio-option-icon">
                                <i class="fas fa-arrow-left"></i>
                            </div>
                            <div class="radio-option-title">Sol Kulak</div>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="{{ form.mold_type.id_for_label }}">{{ form.mold_type.label }}</label>
                        {{ form.mold_type|add_class:"form-control form-select" }}
                    </div>
                    <div class="form-group">
                        <label for="{{ form.vent_diameter.id_for_label }}">{{ form.vent_diameter.label }}</label>
                        {{ form.vent_diameter|add_class:"form-control" }}
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="{{ form.priority.id_for_label }}">{{ form.priority.label }}</label>
                    {{ form.priority|add_class:"form-control form-select" }}
                </div>
            </div>
        </div>

                 <!-- 4. Dosya Yükleme (Sadece dijital için) -->
         <div class="form-card" id="file-upload-section" style="display: {% if not mold or not mold.is_physical_shipment %}block{% else %}none{% endif %}">
            <div class="card-header">
                <h3>
                    <i class="fas fa-file-upload"></i>
                    Tarama Dosyası
                </h3>
            </div>
            <div class="card-body">
                {% if mold and mold.scan_file %}
                <div class="file-info">
                    <i class="fas fa-check-circle"></i>
                    <div>
                        <strong>Mevcut Dosya:</strong>
                        {{ mold.scan_file.name|cut:"scans/" }}
                        <small>({{ mold.scan_file.size|filesizeformat }})</small>
                    </div>
                </div>
                {% endif %}
                
                <div class="file-upload-area" id="fileUploadArea">
                    <div class="file-upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <div class="file-upload-text">Dosya yüklemek için tıklayın</div>
                    <div class="file-upload-hint">
                        veya dosyayı buraya sürükleyip bırakın<br>
                        <small>Desteklenen formatlar: STL, OBJ, PLY, ZIP, RAR (Maks. 100MB)</small>
                    </div>
                    {{ form.scan_file|add_class:"form-control" }}
                    <style>
                        #id_scan_file {
                            display: none;
                        }
                    </style>
                </div>
            </div>
        </div>

        <!-- 5. Notlar ve Talimatlar -->
        <div class="form-card">
            <div class="card-header">
                <h3>
                    <i class="fas fa-sticky-note"></i>
                    Notlar ve Talimatlar
                </h3>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label for="{{ form.notes.id_for_label }}">{{ form.notes.label }}</label>
                    {{ form.notes|add_class:"form-control" }}
                </div>
                <div class="form-group">
                    <label for="{{ form.special_instructions.id_for_label }}">{{ form.special_instructions.label }}</label>
                    {{ form.special_instructions|add_class:"form-control" }}
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
            <a href="{% url 'mold:mold_list' %}" class="btn btn-secondary">
                <i class="fas fa-times"></i>
                İptal
            </a>
            <button type="submit" class="btn btn-primary" id="submitBtn">
                <i class="fas fa-save"></i>
                {% if mold %}Güncelle{% else %}Oluştur{% endif %}
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Form elementleri
    const moldForm = document.getElementById('moldForm');
    const orderTypeOptions = document.querySelectorAll('.radio-option[data-type]');
    const earSideOptions = document.querySelectorAll('.radio-option[data-side]');
    const fileUploadSection = document.getElementById('file-upload-section');
    const fileUploadArea = document.getElementById('fileUploadArea');
    const fileInput = document.querySelector('input[type="file"]');
    const submitBtn = document.getElementById('submitBtn');

    // Initialize form state
    initializeFormState();
    
    // Event listeners
    setupOrderTypeToggle();
    setupEarSideToggle();
    setupFileUpload();
    setupFormValidation();

    function initializeFormState() {
        // Order type initial state
        const checkedOrderType = document.querySelector('input[name="order_type"]:checked');
        if (checkedOrderType) {
            updateOrderTypeUI(checkedOrderType.value);
        }
        
        // Ear side initial state
        const checkedEarSide = document.querySelector('input[name="ear_side"]:checked');
        if (checkedEarSide) {
            updateEarSideUI(checkedEarSide.value);
        }
    }

    function setupOrderTypeToggle() {
        orderTypeOptions.forEach(option => {
            option.addEventListener('click', function() {
                const type = this.dataset.type;
                const radioInput = this.querySelector('input[type="radio"]');
                
                // Update radio selection
                radioInput.checked = true;
                
                // Update UI
                updateOrderTypeUI(type);
            });
        });
    }

    function setupEarSideToggle() {
        earSideOptions.forEach(option => {
            option.addEventListener('click', function() {
                const side = this.dataset.side;
                const radioInput = this.querySelector('input[type="radio"]');
                
                // Update radio selection
                radioInput.checked = true;
                
                // Update UI
                updateEarSideUI(side);
            });
        });
    }

    function updateOrderTypeUI(type) {
        // Update visual selection
        orderTypeOptions.forEach(opt => opt.classList.remove('selected'));
        document.getElementById(`option-${type}`).classList.add('selected');
        
        // Show/hide file upload section
        if (fileUploadSection) {
            fileUploadSection.style.display = type === 'digital' ? 'block' : 'none';
        }
    }

    function updateEarSideUI(side) {
        // Update visual selection
        earSideOptions.forEach(opt => opt.classList.remove('selected'));
        document.getElementById(`side-${side}`).classList.add('selected');
    }

    function setupFileUpload() {
        if (!fileUploadArea || !fileInput) return;

        // Click to upload
        fileUploadArea.addEventListener('click', function(e) {
            if (e.target !== fileInput) {
                fileInput.click();
            }
        });

        // Drag and drop
        fileUploadArea.addEventListener('dragover', handleDragOver);
        fileUploadArea.addEventListener('dragleave', handleDragLeave);
        fileUploadArea.addEventListener('drop', handleDrop);

        // File input change
        fileInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                handleFileSelect(this.files[0]);
            }
        });
    }

    function handleDragOver(e) {
        e.preventDefault();
        fileUploadArea.classList.add('drag-over');
    }

    function handleDragLeave(e) {
        e.preventDefault();
        fileUploadArea.classList.remove('drag-over');
    }

    function handleDrop(e) {
        e.preventDefault();
        fileUploadArea.classList.remove('drag-over');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFileSelect(files[0]);
            fileInput.files = files;
        }
    }

    function handleFileSelect(file) {
        // Validate file
        const allowedExtensions = ['stl', 'obj', 'ply', 'zip', 'rar'];
        const fileExt = file.name.split('.').pop().toLowerCase();
        const maxSize = 100 * 1024 * 1024; // 100MB

        if (!allowedExtensions.includes(fileExt)) {
            alert('Sadece STL, OBJ, PLY, ZIP ve RAR dosyaları yüklenebilir.');
            return;
        }

        if (file.size > maxSize) {
            alert('Dosya boyutu 100MB\'dan büyük olamaz.');
            return;
        }

        // Show file info
        showFileInfo(file);
    }

    function showFileInfo(file) {
        const fileSize = (file.size / 1024 / 1024).toFixed(2);
        
        // Remove existing file info
        const existingInfo = fileUploadArea.querySelector('.file-info');
        if (existingInfo) {
            existingInfo.remove();
        }

        // Create file info element
        const fileInfo = document.createElement('div');
        fileInfo.className = 'file-info';
        fileInfo.innerHTML = `
            <i class="fas fa-check-circle"></i>
            <div>
                <strong>${file.name}</strong>
                <small>(${fileSize} MB)</small>
            </div>
        `;

        fileUploadArea.appendChild(fileInfo);
    }

    function setupFormValidation() {
        moldForm.addEventListener('submit', function(e) {
            const orderType = document.querySelector('input[name="order_type"]:checked')?.value;
            const fileInput = document.querySelector('input[type="file"]');
            
            if (orderType === 'digital' && (!fileInput.files || fileInput.files.length === 0)) {
                e.preventDefault();
                alert('Dijital tarama türü için dosya yüklenmesi zorunludur.');
                return false;
            }

            // Disable submit button to prevent double submission
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> İşleniyor...';
        });
    }
});
</script>
{% endblock %}