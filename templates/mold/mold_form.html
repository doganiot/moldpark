{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container">
    <!-- DEBUG PANEL -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info">
                <h6><i class="fas fa-bug me-2"></i>Debug Bilgileri</h6>
                <div class="row">
                    <div class="col-md-6">
                        <strong>Kalıp Limiti:</strong> {{ used_molds }}/{{ total_limit }} kullanıldı (Kalan: {{ remaining_limit }})<br>
                        <strong>Aktif Ağ Sayısı:</strong> {{ active_networks.count }}<br>
                        {% if active_networks %}
                            <strong>Ağlar:</strong>
                            <ul class="mb-0 mt-1">
                            {% for network in active_networks %}
                                <li>{{ network.producer.company_name }} 
                                    <span class="badge bg-{% if network.producer.is_verified %}success{% else %}warning{% endif %}">
                                        {% if network.producer.is_verified %}Doğrulanmış{% else %}Beklemede{% endif %}
                                    </span>
                                </li>
                            {% endfor %}
                            </ul>
                        {% else %}
                            <span class="text-danger">Hiç aktif ağ yok!</span>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <strong>Form Durumu:</strong>
                        {% if form.errors %}
                            <span class="text-danger">Hatalar var!</span>
                            <ul class="text-danger mt-1">
                            {% for field, errors in form.errors.items %}
                                <li><strong>{{ field }}:</strong> {{ errors|join:", " }}</li>
                            {% endfor %}
                            </ul>
                        {% else %}
                            <span class="text-success">Form hazır</span>
                        {% endif %}
                        <br>
                        <strong>Form Field Durumları:</strong>
                        <ul class="small mt-1">
                            {% for field in form %}
                                <li>{{ field.label }}: 
                                    {% if field.field.disabled %}
                                        <span class="text-danger">Devre dışı</span>
                                    {% else %}
                                        <span class="text-success">Aktif</span>
                                    {% endif %}
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'mold:mold_list' %}">Kalıplarım</a></li>
                    <li class="breadcrumb-item active">
                        {% if object %}
                            {{ object.patient_name }} - Düzenle
                        {% else %}
                            Yeni Kalıp
                        {% endif %}
                    </li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- Network Uyarısı -->
    {% if not active_networks %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-danger">
                <div class="d-flex align-items-center">
                    <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
                    <div>
                        <h6 class="mb-1">Üretici Ağı Gerekli</h6>
                        <p class="mb-2">Kalıp siparişi verebilmek için bir üretici ağına katılmanız gerekiyor.</p>
                        <a href="{% url 'center:network_management' %}" class="btn btn-warning btn-sm">
                            <i class="fas fa-network-wired me-1"></i>Ağ Yönetimi
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Limit Uyarısı -->
    {% if remaining_limit <= 0 %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-warning">
                <div class="d-flex align-items-center">
                    <i class="fas fa-exclamation-circle fa-2x me-3"></i>
                    <div>
                        <h6 class="mb-1">Kalıp Limiti Doldu</h6>
                        <p class="mb-0">{{ total_limit }} kalıp limitinizi doldurdunuz. Daha fazla kalıp oluşturamazsınız.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0">
                    <h5 class="mb-0">
                        {% if object %}
                            Kalıp Düzenle
                        {% else %}
                            Yeni Kalıp Oluştur
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    {% if not active_networks %}
                    <div class="text-center py-5">
                        <i class="fas fa-network-wired fa-3x text-muted mb-3"></i>
                        <h6 class="text-muted">Üretici ağına bağlı değilsiniz</h6>
                        <p class="text-muted">Kalıp oluşturmak için önce bir üretici ağına katılmalısınız.</p>
                        <a href="{% url 'center:network_management' %}" class="btn btn-primary">
                            <i class="fas fa-network-wired me-1"></i>Ağ Yönetimi
                        </a>
                    </div>
                    {% elif remaining_limit <= 0 %}
                    <div class="text-center py-5">
                        <i class="fas fa-ban fa-3x text-muted mb-3"></i>
                        <h6 class="text-muted">Kalıp limiti doldu</h6>
                        <p class="text-muted">{{ total_limit }} kalıp limitinizi doldurdunuz.</p>
                    </div>
                    {% else %}
                    <form method="post" enctype="multipart/form-data" class="row g-3">
                        {% csrf_token %}

                        <!-- Sipariş Türü -->
                        {% if form.order_type %}
                        <div class="col-12">
                            <h6 class="mb-3">Sipariş Türü</h6>
                            {{ form.order_type|as_crispy_field }}
                        </div>
                        {% endif %}

                        <!-- Öncelik -->
                        {% if form.priority %}
                        <div class="col-12">
                            <h6 class="mb-3">Öncelik</h6>
                            {{ form.priority|as_crispy_field }}
                        </div>
                        {% endif %}

                        <!-- Patient Information -->
                        <div class="col-12">
                            <h6 class="mb-3">Hasta Bilgileri</h6>
                        </div>
                        <div class="col-md-4">
                            {{ form.patient_name|as_crispy_field }}
                        </div>
                        <div class="col-md-4">
                            {{ form.patient_surname|as_crispy_field }}
                        </div>
                        <div class="col-md-2">
                            {{ form.patient_age|as_crispy_field }}
                        </div>
                        <div class="col-md-2">
                            {{ form.patient_gender|as_crispy_field }}
                        </div>

                        <!-- Mold Information -->
                        <div class="col-12">
                            <h6 class="mb-3 mt-4">Kalıp Bilgileri</h6>
                        </div>
                        <div class="col-md-6">
                            {{ form.mold_type|as_crispy_field }}
                        </div>
                        <div class="col-md-6">
                            {{ form.vent_diameter|as_crispy_field }}
                        </div>

                        <!-- File Upload -->
                        <div class="col-12">
                            <h6 class="mb-3 mt-4">Dosya Yükleme</h6>
                        </div>
                        <div class="col-12">
                            {% if object and object.scan_file %}
                                <div class="alert alert-info">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-info-circle fa-2x me-3"></i>
                                        <div>
                                            <h6 class="mb-1">Mevcut Dosya</h6>
                                            <p class="mb-0">
                                                {{ object.scan_file.name|cut:"scans/" }}
                                                <small class="text-muted">
                                                    ({{ object.scan_file.size|filesizeformat }})
                                                </small>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                            {{ form.scan_file|as_crispy_field }}
                            <small class="text-muted">
                                Desteklenen formatlar: STL, OBJ, PLY, ZIP, RAR<br>
                                Maksimum dosya boyutu: 100MB
                            </small>
                        </div>

                        <!-- Notes -->
                        <div class="col-12">
                            <h6 class="mb-3 mt-4">Notlar</h6>
                        </div>
                        <div class="col-12">
                            {{ form.notes|as_crispy_field }}
                        </div>

                        <!-- Özel Talimatlar -->
                        {% if form.special_instructions %}
                        <div class="col-12">
                            <h6 class="mb-3 mt-4">Özel Talimatlar</h6>
                            {{ form.special_instructions|as_crispy_field }}
                        </div>
                        {% endif %}

                        <!-- Submit -->
                        <div class="col-12 mt-4">
                            <div class="d-flex justify-content-between">
                                <a href="{% url 'mold:mold_list' %}" class="btn btn-outline-secondary">
                                    <i class="fas fa-arrow-left me-2"></i>Geri
                                </a>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Kalıp Oluştur ve Sipariş Gönder
                                </button>
                            </div>
                        </div>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Help Card -->
        <div class="col-md-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0">
                    <h5 class="mb-0">Yardım & Durum</h5>
                </div>
                <div class="card-body">
                    <!-- Durum Bilgisi -->
                    <div class="mb-4">
                        <h6>Sistem Durumu</h6>
                        <div class="list-group list-group-flush">
                            <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                Kalıp Limiti
                                <span class="badge bg-{% if remaining_limit > 5 %}success{% elif remaining_limit > 0 %}warning{% else %}danger{% endif %}">
                                    {{ remaining_limit }}/{{ total_limit }}
                                </span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                Aktif Ağlar
                                <span class="badge bg-{% if active_networks.count > 0 %}success{% else %}danger{% endif %}">
                                    {{ active_networks.count }}
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <h6>Kalıp Tipleri</h6>
                        <ul class="list-unstyled mb-0">
                            <li><i class="fas fa-check-circle text-success me-2"></i>Tam Konka</li>
                            <li><i class="fas fa-check-circle text-success me-2"></i>Yarım Konka</li>
                            <li><i class="fas fa-check-circle text-success me-2"></i>İskelet Tip</li>
                            <li><i class="fas fa-check-circle text-success me-2"></i>Probe</li>
                            <li><i class="fas fa-check-circle text-success me-2"></i>CIC</li>
                            <li><i class="fas fa-check-circle text-success me-2"></i>ITE</li>
                            <li><i class="fas fa-check-circle text-success me-2"></i>ITC</li>
                        </ul>
                    </div>
                    <div class="mb-4">
                        <h6>Vent Çapı</h6>
                        <p class="text-muted small mb-0">
                            Vent çapı, kalıbın havalandırma deliğinin çapını milimetre cinsinden belirtir.
                            Genellikle 1-3mm arasında olur.
                        </p>
                    </div>
                    <div>
                        <h6>Dosya Gereksinimleri</h6>
                        <p class="text-muted small mb-0">
                            Tarama dosyanızın STL, OBJ, PLY, ZIP veya RAR formatında olması gerekir.
                            Dosya boyutu 100MB'ı geçmemelidir.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    // File input validation
    document.querySelector('input[type="file"]').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            // Check file size (100MB)
            if (file.size > 104857600) {
                alert('Dosya boyutu 100MB\'ı geçemez.');
                e.target.value = '';
                return;
            }

            // Check file extension
            const ext = file.name.split('.').pop().toLowerCase();
            if (!['stl', 'obj', 'ply', 'zip', 'rar'].includes(ext)) {
                alert('Sadece STL, OBJ, PLY, ZIP ve RAR dosyaları yüklenebilir.');
                e.target.value = '';
                return;
            }
        }
    });
</script>
{% endblock %}
{% endblock %}