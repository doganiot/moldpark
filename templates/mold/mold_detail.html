{% extends 'base.html' %}
{% load humanize %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'mold:mold_list' %}">Kalıplarım</a></li>
                    <li class="breadcrumb-item active">{{ mold.patient_name }}</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row">
        <!-- Mold Details -->
        <div class="col-md-8">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Kalıp Detayları</h5>
                        <div class="btn-group">
                            <a href="{% url 'mold:mold_edit' mold.id %}" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-edit me-1"></i>Düzenle
                            </a>
                            <a href="{% url 'mold:mold_delete' mold.id %}" 
                               class="btn btn-sm btn-outline-danger"
                               onclick="return confirm('Bu kalıbı silmek istediğinize emin misiniz?')">
                                <i class="fas fa-trash me-1"></i>Sil
                            </a>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <dl class="row">
                                <dt class="col-sm-4">Hasta Adı</dt>
                                <dd class="col-sm-8">{{ mold.patient_name }}</dd>

                                <dt class="col-sm-4">Yaş</dt>
                                <dd class="col-sm-8">{{ mold.patient_age }}</dd>

                                <dt class="col-sm-4">Cinsiyet</dt>
                                <dd class="col-sm-8">{{ mold.get_patient_gender_display }}</dd>

                                <dt class="col-sm-4">Kalıp Tipi</dt>
                                <dd class="col-sm-8">{{ mold.get_mold_type_display }}</dd>
                            </dl>
                        </div>
                        <div class="col-md-6">
                            <dl class="row">
                                <dt class="col-sm-4">Vent Çapı</dt>
                                <dd class="col-sm-8">{{ mold.vent_diameter }} mm</dd>

                                <dt class="col-sm-4">Durum</dt>
                                <dd class="col-sm-8">
                                    <span class="badge bg-{{ mold.get_status_color }} fs-6">
                                        {{ mold.get_status_display }}
                                    </span>
                                    {% if mold.status == 'completed' %}
                                    <br>
                                    <small class="text-success">
                                        <i class="fas fa-check-circle me-1"></i>
                                        İşlenmiş model hazır!
                                    </small>
                                    {% endif %}
                                </dd>

                                <dt class="col-sm-4">Oluşturulma</dt>
                                <dd class="col-sm-8">{{ mold.created_at|naturaltime }}</dd>

                                <dt class="col-sm-4">Son Güncelleme</dt>
                                <dd class="col-sm-8">{{ mold.updated_at|naturaltime }}</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Files -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-0">
                    <h5 class="mb-0">Dosyalar</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Tarama Dosyası</h6>
                            {% if mold.scan_file %}
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-file-alt fa-2x text-primary me-3"></i>
                                    <div>
                                        <a href="{{ mold.scan_file.url }}" class="text-decoration-none">
                                            {{ mold.scan_file.name|cut:"scans/" }}
                                        </a>
                                        <br>
                                        <small class="text-muted">
                                            Yüklenme: {{ mold.created_at|naturaltime }}
                                        </small>
                                    </div>
                                </div>
                            {% else %}
                                <p class="text-muted">Henüz tarama dosyası yüklenmemiş.</p>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <h6>İşlenmiş Modeller</h6>
                            {% if mold.modeled_files.exists %}
                                {% for model in mold.modeled_files.all %}
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-file-download fa-2x text-success me-3"></i>
                                    <div>
                                        <a href="{{ model.file.url }}" class="text-decoration-none fw-medium" download>
                                            {{ model.file.name|cut:"modeled/"|truncatechars:25 }}
                                        </a>
                                        <br>
                                        <small class="text-muted">
                                            <span class="badge {% if model.status == 'approved' %}bg-success{% elif model.status == 'rejected' %}bg-danger{% else %}bg-warning text-dark{% endif %} me-1">
                                                {% if model.status == 'approved' %}
                                                    <i class="fas fa-check me-1"></i>
                                                {% endif %}
                                                {{ model.get_status_display }}
                                            </span>
                                            {{ model.created_at|naturaltime }}
                                        </small>
                                        {% if model.notes %}
                                        <br>
                                        <small class="text-info">{{ model.notes|truncatechars:50 }}</small>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <p class="text-muted">Henüz işlenmiş model yok.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- İşlenmiş Modeller Bölümü -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-cube me-2"></i>İşlenmiş Modeller</h5>
                        {% if mold.modeled_files.exists %}
                        <span class="badge bg-success">{{ mold.modeled_files.count }} Model</span>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    {% if mold.modeled_files.exists %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Dosya</th>
                                    <th>Durum</th>
                                    <th>Notlar</th>
                                    <th>Tarih</th>
                                    <th>İşlem</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for model in mold.modeled_files.all %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-file-download text-primary me-2"></i>
                                            <div>
                                                <strong>{{ model.file.name|cut:"modeled/"|truncatechars:30 }}</strong>
                                                <br>
                                                <small class="text-muted">{{ model.file.size|filesizeformat }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge {% if model.status == 'approved' %}bg-success{% elif model.status == 'rejected' %}bg-danger{% else %}bg-warning text-dark{% endif %}">
                                            {{ model.get_status_display }}
                                        </span>
                                        {% if model.status == 'approved' %}
                                        <br>
                                        <small class="text-success">
                                            <i class="fas fa-check-double me-1"></i>
                                            Hazır
                                        </small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if model.notes %}
                                            <span data-bs-toggle="tooltip" title="{{ model.notes }}">
                                                {{ model.notes|truncatechars:30 }}
                                            </span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div>
                                            <strong>{{ model.created_at|date:"d.m.Y" }}</strong>
                                            <br>
                                            <small class="text-muted">{{ model.created_at|date:"H:i" }}</small>
                                        </div>
                                    </td>
                                    <td>
                                        <a href="{{ model.file.url }}" class="btn btn-sm btn-success" title="İndir" download>
                                            <i class="fas fa-download me-1"></i>İndir
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-cube fa-4x text-muted mb-3"></i>
                        <h6 class="text-muted">Henüz işlenmiş model yok</h6>
                        <p class="text-muted mb-0">Ana merkez kalıbınızı işlediğinde modeller burada görünecek.</p>
                        <div class="mt-3">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Bilgi:</strong> İşlenmiş modeller hazır olduğunda size bildirim gönderilecek.
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-md-4">
            <!-- Status Timeline -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-0">
                    <h5 class="mb-0">Durum Geçmişi</h5>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        {% for status in mold.status_history.all %}
                        <div class="timeline-item">
                            <div class="timeline-marker bg-{{ status.get_status_color }}"></div>
                            <div class="timeline-content">
                                <h6 class="mb-0">{{ status.get_status_display }}</h6>
                                <small class="text-muted">{{ status.created_at|naturaltime }}</small>
                            </div>
                        </div>
                        {% empty %}
                        <p class="text-muted">Henüz durum değişikliği yok.</p>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Revisions -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Revizyonlar</h5>
                        <button type="button" 
                                class="btn btn-sm btn-primary" 
                                data-bs-toggle="modal" 
                                data-bs-target="#revisionModal">
                            <i class="fas fa-plus me-1"></i>Revizyon Talep Et
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    {% for revision in mold.revisions.all %}
                    <div class="revision-item {% if not forloop.last %}mb-3{% endif %}">
                        <div class="d-flex">
                            <div class="flex-shrink-0">
                                <div class="bg-light rounded-circle p-2">
                                    <i class="fas fa-redo"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <p class="mb-1">{{ revision.description }}</p>
                                <small class="text-muted">{{ revision.created_at|naturaltime }}</small>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted">Henüz revizyon talebi yok.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Revision Modal -->
<div class="modal fade" id="revisionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Revizyon Talebi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'mold:revision_create' mold.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Revizyon Açıklaması</label>
                        <textarea name="description" class="form-control" rows="3" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="submit" class="btn btn-primary">Gönder</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% block extra_css %}
<style>
    .timeline {
        position: relative;
        padding-left: 3rem;
    }

    .timeline::before {
        content: '';
        position: absolute;
        left: 1rem;
        top: 0;
        height: 100%;
        width: 2px;
        background: #e9ecef;
    }

    .timeline-item {
        position: relative;
        padding-bottom: 1.5rem;
    }

    .timeline-marker {
        position: absolute;
        left: -2rem;
        width: 1rem;
        height: 1rem;
        border-radius: 50%;
    }

    .timeline-content {
        padding-left: 0.5rem;
    }

    .revision-item {
        position: relative;
    }

    .revision-item::after {
        content: '';
        position: absolute;
        left: 1.5rem;
        top: 3rem;
        height: calc(100% - 1rem);
        width: 2px;
        background: #e9ecef;
    }

    .revision-item:last-child::after {
        display: none;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
// Tooltip'leri etkinleştir
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}
{% endblock %} 