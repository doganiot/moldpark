{% extends 'base.html' %}
{% load humanize %}

{% block title %}Finansal Kontrol Paneli - MoldPark Admin{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #F5B427 0%, #D49A1F 100%);">
                <div class="card-body p-4 text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="mb-1 fw-bold">
                                <i class="fas fa-chart-line me-2"></i>
                                Finansal Kontrol Paneli
                            </h3>
                            <p class="mb-0 opacity-75">Tüm para akışı, tahsilatlar ve ödemeler</p>
                        </div>
                        <div class="text-end">
                            <h4 class="mb-0">{{ period_name }}</h4>
                            <small class="opacity-75">{{ start_date|date:"d.m.Y" }} - {{ end_date|date:"d.m.Y" }}</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Period Filter -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="btn-group" role="group">
                        <a href="?period=this_month" class="btn {% if period == 'this_month' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                            Bu Ay
                        </a>
                        <a href="?period=last_month" class="btn {% if period == 'last_month' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                            Geçen Ay
                        </a>
                        <a href="?period=this_year" class="btn {% if period == 'this_year' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                            Bu Yıl
                        </a>
                        <a href="?period=all_time" class="btn {% if period == 'all_time' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                            Tüm Zamanlar
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hesaplama Açıklaması -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info alert-dismissible fade show" role="alert">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Finansal Hesaplama Yöntemi:</strong>
                <ul class="mb-0 mt-2">
                    <li><strong>MoldPark Hizmet Bedeli (%7.5):</strong> İşitme merkezlerinden tahsil edilen brüt tutar (KDV dahil) × %7.5</li>
                    <li><strong>Üreticiye Ödeme:</strong> Brüt tutar - MoldPark hizmet bedeli (Aylık sistem kullanım ücretleri dahil değil)</li>
                </ul>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        </div>
    </div>

    <!-- Para Akışı Özeti -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-0 shadow-sm h-100" style="border-left: 4px solid #10b981 !important;">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-success bg-opacity-10 rounded-circle p-3">
                                <i class="fas fa-arrow-down text-success fa-2x"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <div class="text-muted small">İşitme Merkezlerinden</div>
                            <h4 class="mb-0 fw-bold text-success">₺{{ cash_flow.total_incoming|floatformat:2 }}</h4>
                            <small class="text-muted">Toplam Tahsilat <span class="text-info">(Fiziksel kalıp + 3D modelleme + Aylık sistem ücretleri - KDV dahil)</span></small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-0 shadow-sm h-100" style="border-left: 4px solid #ef4444 !important;">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-danger bg-opacity-10 rounded-circle p-3">
                                <i class="fas fa-arrow-up text-danger fa-2x"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <div class="text-muted small">Üreticilere</div>
                            <h4 class="mb-0 fw-bold text-danger">₺{{ cash_flow.total_outgoing|floatformat:2 }}</h4>
                            <small class="text-muted">Toplam Ödeme <span class="text-info">(Toplam tahsilat - (Aylık ücret + MoldPark komisyonu %7.5))</span></small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-0 shadow-sm h-100" style="border-left: 4px solid #f59e0b !important;">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-warning bg-opacity-10 rounded-circle p-3">
                                <i class="fas fa-percentage text-warning fa-2x"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <div class="text-muted small">Hizmet Bedeli (%7.5 - KDV DAHİL tutardan)</div>
                            <h4 class="mb-0 fw-bold text-warning">₺{{ cash_flow.moldpark_service_income|floatformat:2 }}</h4>
                            <small class="text-muted">MoldPark Geliri <span class="text-info">((Toplam gelir - Aylık ücret) × %7.5)</span></small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- İkinci Satır Kartlar -->
    <div class="row mb-4">
        <div class="col-lg-6 col-md-6 mb-3">
            <div class="card border-0 shadow-sm h-100" style="border-left: 4px solid #8b5cf6 !important;">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-primary bg-opacity-10 rounded-circle p-3">
                                <i class="fas fa-coins text-primary fa-2x"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <div class="text-muted small">MoldPark Net Kar</div>
                            <h4 class="mb-0 fw-bold text-primary">₺{{ cash_flow.moldpark_net_profit|floatformat:2 }}</h4>
                            <small class="text-muted">Hizmet Bedeli <span class="text-info">(total_moldpark_service_fee - kredi kartı komisyonu artık düşülmüyor)</span></small>
                        </div>
                    </div>
                    <hr class="my-3">
                    <div class="row text-center">
                        <div class="col-12">
                            <small class="text-muted d-block">Hizmet Bedeli <span class="text-info">((Toplam gelir - Aylık ücret) × %7.5)</span></small>
                            <strong class="text-success">+₺{{ cash_flow.moldpark_service_income|floatformat:2 }}</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6 col-md-6 mb-3">
            <div class="card border-0 shadow-sm h-100" style="border-left: 4px solid #06b6d4 !important;">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-info bg-opacity-10 rounded-circle p-3">
                                <i class="fas fa-balance-scale text-info fa-2x"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <div class="text-muted small">Gerçek Bakiye</div>
                            <h4 class="mb-0 fw-bold text-info">₺{{ cash_flow.balance|floatformat:2 }}</h4>
                            <small class="text-muted">Tahsilat - Ödeme <span class="text-info">(total_collections_from_centers - total_payments_to_producers)</span></small>
                        </div>
                    </div>
                    <hr class="my-3">
                    <div class="row text-center small">
                        <div class="col-6 border-end">
                            <small class="text-muted d-block">Tahsilat <span class="text-info">(Fiziksel + 3D + Aylık ücret)</span></small>
                            <strong class="text-success">+₺{{ cash_flow.total_incoming|floatformat:0 }}</strong>
                        </div>
                        <div class="col-6">
                            <small class="text-muted d-block">Ödeme <span class="text-info">(Brüt - %7.5 komisyon)</span></small>
                            <strong class="text-danger">-₺{{ cash_flow.total_outgoing|floatformat:0 }}</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Aylık Sistem Ücretleri Kartı -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm" style="border-left: 4px solid #10b981 !important;">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-success bg-opacity-10 rounded-circle p-3">
                                <i class="fas fa-calendar-check text-success fa-2x"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <div class="text-muted small">Aylık Sistem Kullanım Ücretleri</div>
                            <h4 class="mb-0 fw-bold text-success">₺{{ cash_flow.monthly_system_fees|floatformat:2 }}</h4>
                            <small class="text-muted">{{ total_centers }} Aktif Merkez × ₺{{ pricing.monthly_system_fee|floatformat:0 }} <span class="text-info">(UserSubscription.plan.monthly_fee_try veya pricing.monthly_system_fee)</span></small>
                        </div>
                        <div class="flex-shrink-0 text-end">
                            <div class="badge bg-success fs-6 px-3 py-2">
                                <i class="fas fa-check-circle me-1"></i>
                                MoldPark Geliri
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detaylı Para Akışı -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0">
                    <h5 class="mb-0 fw-bold">
                        <i class="fas fa-exchange-alt me-2 text-info"></i>
                        Para Akışı Detayı
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-borderless">
                            <tbody>
                                <tr class="border-bottom">
                                    <td class="py-3">
                                        <i class="fas fa-arrow-down text-success me-2"></i>
                                        <strong>İşitme Merkezlerinden Tahsilat</strong>
                                    </td>
                                    <td class="text-end py-3">
                                        <span class="badge bg-success px-3 py-2">
                                            +₺{{ cash_flow.total_incoming|floatformat:2 }}
                                        </span>
                                    </td>
                                </tr>
                                <tr class="border-bottom">
                                    <td class="py-3 ps-4">
                                        <i class="fas fa-minus-circle text-warning me-2"></i>
                                        MoldPark Hizmet Bedeli (%7.5)
                                    </td>
                                    <td class="text-end py-3">
                                        <span class="text-warning">-₺{{ cash_flow.moldpark_service_income|floatformat:2 }}</span>
                                    </td>
                                </tr>
                                <tr class="border-bottom">
                                    <td class="py-3">
                                        <i class="fas fa-arrow-up text-danger me-2"></i>
                                        <strong>Üreticilere Ödeme</strong>
                                    </td>
                                    <td class="text-end py-3">
                                        <span class="badge bg-danger px-3 py-2">
                                            -₺{{ cash_flow.total_outgoing|floatformat:2 }}
                                        </span>
                                    </td>
                                </tr>
                                <tr class="table-light">
                                    <td class="py-3">
                                        <i class="fas fa-equals text-primary me-2"></i>
                                        <strong>MoldPark Net Kar</strong>
                                        <br>
                                        <small class="text-success fst-italic">
                                            <i class="fas fa-check-circle me-1"></i>
                                            Hizmet bedeli (%7.5)
                                        </small>
                                    </td>
                                    <td class="text-end py-3">
                                        <h4 class="mb-0 text-primary">
                                            ₺{{ cash_flow.moldpark_net_profit|floatformat:2 }}
                                        </h4>
                                        <small class="text-muted">Net kazanç</small>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- İşitme Merkezlerinden Tahsilatlar -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-hospital me-2"></i>
                        İşitme Merkezlerinden Tahsilatlar
                        <span class="badge bg-light text-dark ms-2">{{ centers_with_physical_molds|length }}</span>
                    </h5>
                </div>
                <div class="card-body p-0">
                    {% if centers_with_physical_molds %}
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Merkez</th>
                                        <th class="text-center">
                                            Hizmetler
                                            <br><small class="text-muted" style="font-weight: normal;">Fiziksel / Dijital</small>
                                        </th>
                                        <th class="text-end">
                                            Aylık Ücret
                                            <br><small class="text-muted" style="font-weight: normal;">Sistem Kullanımı</small>
                                        </th>
                                        <th class="text-end">KDV Hariç</th>
                                        <th class="text-end">KDV (%20)</th>
                                        <th class="text-end">Toplam</th>
                                        <th class="text-end">MoldPark</th>
                                        <th class="text-center">İşlemler</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in centers_with_physical_molds %}
                                    <tr>
                                        <td>
                                            <i class="fas fa-building text-primary me-2"></i>
                                            <strong>{{ item.center.name }}</strong>
                                        </td>
                                        <td class="text-center">
                                            {% if item.has_package_invoice %}
                                                <span class="badge bg-success" title="Paket Faturası - {{ item.package_invoice_numbers|join:', ' }}">
                                                    <i class="fas fa-gift me-1"></i>{{ item.package_info|default:"Paket" }}
                                                </span>
                                                {% if item.package_invoice_numbers %}
                                                    {% if item.package_invoice_numbers.0 == "Fatura Oluşturulmamış" %}
                                                        <br><small class="text-warning"><i class="fas fa-exclamation-triangle me-1"></i>Fatura Oluşturulmamış</small>
                                                    {% else %}
                                                        <br><small class="text-muted">{{ item.package_invoice_numbers.0|truncatechars:20 }}</small>
                                                    {% endif %}
                                                {% endif %}
                                            {% else %}
                                                <div class="d-flex flex-column gap-2">
                                                    {% if item.physical_count > 0 %}
                                                        <div>
                                                            <span class="badge bg-primary" title="Fiziksel Kalıp">
                                                                <i class="fas fa-box me-1"></i>{{ item.physical_count }}
                                                            </span>
                                                            <br><small class="text-muted">₺{{ item.physical_amount|floatformat:0 }}</small>
                                                        </div>
                                                    {% endif %}
                                                    {% if item.digital_count > 0 %}
                                                        <div>
                                                            <span class="badge bg-info" title="3D Modelleme">
                                                                <i class="fas fa-cube me-1"></i>{{ item.digital_count }}
                                                            </span>
                                                            <br><small class="text-muted">₺{{ item.digital_amount|floatformat:0 }}</small>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            {% endif %}
                                        </td>
                                        <td class="text-end">
                                            <span class="badge bg-success" title="Aylık Sistem Kullanım Ücreti">
                                                <i class="fas fa-calendar-check me-1"></i>₺{{ item.monthly_system_fee|floatformat:0 }}
                                            </span>
                                        </td>
                                        <td class="text-end">
                                            {% if item.has_package_invoice %}
                                                ₺{{ item.package_amount|floatformat:2 }}
                                            {% else %}
                                                ₺{{ item.gross_amount_without_vat|floatformat:2 }}
                                            {% endif %}
                                        </td>
                                        <td class="text-end text-info">
                                            {% if item.has_package_invoice %}
                                                ₺{{ item.vat_amount|floatformat:2 }}
                                            {% else %}
                                                ₺{{ item.vat_amount|floatformat:2 }}
                                            {% endif %}
                                        </td>
                                        <td class="text-end">
                                            <strong>
                                                {% if item.has_package_invoice %}
                                                    ₺{{ item.package_amount|floatformat:2 }}
                                                {% else %}
                                                    ₺{{ item.gross_amount|floatformat:2 }}
                                                {% endif %}
                                            </strong>
                                        </td>
                                        <td class="text-end text-warning">₺{{ item.moldpark_fee|floatformat:2 }}</td>
                                        <td class="text-center">
                                            <button type="button" 
                                                    class="btn btn-sm btn-success" 
                                                    onclick="createSingleCenterInvoice({{ item.center.id }}, '{{ item.center.name }}')"
                                                    title="Bu merkeze fatura kes">
                                                <i class="fas fa-file-invoice me-1"></i>Fatura Kes
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot class="table-light">
                                    <tr>
                                        <td colspan="5"><strong>TOPLAM</strong></td>
                                        <td class="text-end"><strong>₺{{ total_collections_from_centers|floatformat:2 }}</strong></td>
                                        <td class="text-end text-warning"><strong>₺{{ total_moldpark_service_fee|floatformat:2 }}</strong></td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        {% if centers_with_physical_molds %}
                        <div class="card-footer bg-white border-0">
                            <button type="button" class="btn btn-success" onclick="bulkCreateCenterInvoices()">
                                <i class="fas fa-file-invoice-dollar me-2"></i>
                                Tüm Merkezlere Fatura Kes ve Gönder
                            </button>
                        </div>
                        {% endif %}
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Bu dönemde fiziksel kalıp gönderimi yok</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Üreticilere Ödemeler -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0">
                    <h6 class="mb-0 fw-bold">
                        <i class="fas fa-money-bill-wave me-2 text-info"></i>
                        Üreticilere Ödemeler
                    </h6>
                </div>
                <div class="card-body">
                    {% if producers_payment_summary %}
                        <div class="table-responsive">
                            <table class="table table-sm table-hover mb-0">
                                <thead>
                                    <tr class="table-light">
                                        <th>Üretici Merkez</th>
                                        <th class="text-end">Fiziksel</th>
                                        <th class="text-end">3D</th>
                                        <th class="text-end">Net Ödeme</th>
                                        <th class="text-center">Durum</th>
                                        <th class="text-center">İşlem</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in producers_payment_summary %}
                                        {% if item.total_orders > 0 %}
                                        <tr>
                                            <td>
                                                <small class="fw-bold">{{ item.producer.name }}</small>
                                                <br>
                                                <small class="text-muted">{{ item.producer.company_name }}</small>
                                            </td>
                                            <td class="text-end">
                                                <small>{{ item.physical_count }}</small>
                                            </td>
                                            <td class="text-end">
                                                <small>{{ item.digital_count }}</small>
                                            </td>
                                            <td class="text-end">
                                                <strong class="text-primary">{{ item.net_payment|floatformat:2 }} ₺</strong>
                                            </td>
                                            <td class="text-center">
                                                {% if item.is_paid %}
                                                    <span class="badge bg-success">
                                                        <i class="fas fa-check me-1"></i>Ödendi
                                                    </span>
                                                {% else %}
                                                    <span class="badge bg-warning">
                                                        <i class="fas fa-clock me-1"></i>Bekliyor
                                                    </span>
                                                {% endif %}
                                            </td>
                                            <td class="text-center">
                                                {% if not item.is_paid %}
                                                    <div class="btn-group btn-group-sm" role="group">
                                                        <button type="button" 
                                                                class="btn btn-outline-info"
                                                                onclick="showPaymentNotificationModal({{ item.producer.id }}, '{{ item.producer.name }}', '{{ item.net_payment }}')"
                                                                title="Ödeme Bilgilendirmesi Gönder">
                                                            <i class="fas fa-envelope"></i>
                                                        </button>
                                                        <button type="button" 
                                                                class="btn btn-outline-success"
                                                                onclick="markProducerAsPaid({{ item.producer.id }}, '{{ item.producer.name }}')"
                                                                title="Ödendi Olarak İşaretle">
                                                            <i class="fas fa-check"></i>
                                                        </button>
                                                    </div>
                                                {% else %}
                                                    <small class="text-muted">Tamamlandı</small>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endif %}
                                    {% endfor %}
                                </tbody>
                                <tfoot>
                                    <tr class="table-light fw-bold">
                                        <td colspan="3">TOPLAM ÖDEMELER:</td>
                                        <td class="text-end text-primary">{{ total_payments_to_producers|floatformat:2 }} ₺</td>
                                        <td colspan="2"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            Bu dönemde ödemesi gereken üretici merkez bulunmamaktadır.
                        </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Üretici Ödemeleri Detay Özeti -->
    <div class="row mt-3">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0">
                    <h6 class="mb-0 fw-bold">
                        <i class="fas fa-chart-line me-2 text-info"></i>
                        Üretici Ödemeleri Detay Özeti
                    </h6>
                </div>
                <div class="card-body">
                    {% if producers_payment_summary %}
                        <div class="row g-3">
                            <!-- Tamamlanan İşler -->
                            <div class="col-md-3">
                                <div class="p-3 border rounded-3 border-info bg-info bg-opacity-5">
                                    <small class="text-muted d-block mb-2">Toplam Tamamlanan İşler</small>
                                    <h5 class="mb-1 text-info">
                                        {{ total_completed_producer_orders|default:0 }}
                                    </h5>
                                    <small class="text-muted">
                                        {% with physical=total_physical_molds digital=total_digital_molds %}
                                            {{ physical }} fiziksel + {{ digital }} 3D
                                        {% endwith %}
                                    </small>
                                </div>
                            </div>

                            <!-- Brüt Gelir (KDV Dahil) -->
                            <div class="col-md-3">
                                <div class="p-3 border rounded-3 border-success bg-success bg-opacity-5">
                                    <small class="text-muted d-block mb-2">Brüt Gelir (KDV Dahil)</small>
                                    <h5 class="mb-1 text-success">
                                        ₺{{ total_producer_gross_revenue|floatformat:0 }}
                                    </h5>
                                    <small class="text-muted">
                                        Satış fiyatlarından toplam
                                    </small>
                                </div>
                            </div>

                            <!-- KDV Tutarı -->
                            <div class="col-md-3">
                                <div class="p-3 border rounded-3 border-warning bg-warning bg-opacity-5">
                                    <small class="text-muted d-block mb-2">KDV Tutarı (%20)</small>
                                    <h5 class="mb-1 text-warning">
                                        ₺{{ total_producer_vat|floatformat:0 }}
                                    </h5>
                                    <small class="text-muted">
                                        Kesilen vergi
                                    </small>
                                </div>
                            </div>

                            <!-- MoldPark Komisyonu -->
                            <div class="col-md-3">
                                <div class="p-3 border rounded-3 border-danger bg-danger bg-opacity-5">
                                    <small class="text-muted d-block mb-2">MoldPark Komisyonu</small>
                                    <h5 class="mb-1 text-danger">
                                        ₺{{ total_moldpark_producer_fee|floatformat:0 }}
                                    </h5>
                                    <small class="text-muted">
                                        Hizmet bedeli (%7.5)
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Detaylı Hesaplama Tablosu -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="table-responsive">
                                    <table class="table table-sm mb-0">
                                        <tbody>
                                            <!-- Brüt Gelir (KDV Dahil) -->
                                            <tr class="border-top-2">
                                                <td width="60%">
                                                    <strong>Brüt Gelir (KDV Dahil)</strong>
                                                    <br>
                                                    <small class="text-muted">Tüm işlerin satış fiyatları</small>
                                                </td>
                                                <td class="text-end">
                                                    <h6 class="mb-0">₺{{ total_producer_gross_revenue|floatformat:2 }}</h6>
                                                </td>
                                            </tr>

                                            <!-- KDV Kesinti -->
                                            <tr>
                                                <td>
                                                    <strong>- KDV Kesintisi (%20)</strong>
                                                    <br>
                                                    <small class="text-muted">Muhasebe hesabına aktarılan tutar</small>
                                                </td>
                                                <td class="text-end text-danger">
                                                    <h6 class="mb-0">- ₺{{ total_producer_vat|floatformat:2 }}</h6>
                                                </td>
                                            </tr>

                                            <!-- Net Gelir (KDV Hariç) -->
                                            <tr class="table-light">
                                                <td>
                                                    <strong>= Net Gelir (KDV Hariç)</strong>
                                                    <br>
                                                    <small class="text-muted">Muhasebe tutarı</small>
                                                </td>
                                                <td class="text-end">
                                                    <h6 class="mb-0 text-primary">₺{{ total_producer_gross_without_vat|floatformat:2 }}</h6>
                                                </td>
                                            </tr>

                                            <!-- MoldPark Komisyonu -->
                                            <tr>
                                                <td>
                                                    <strong>- MoldPark Komisyonu (%7.5)</strong>
                                                    <br>
                                                    <small class="text-muted">Platform hizmet bedeli</small>
                                                </td>
                                                <td class="text-end text-danger">
                                                    <h6 class="mb-0">- ₺{{ total_moldpark_producer_fee|floatformat:2 }}</h6>
                                                </td>
                                            </tr>

                                            <!-- Net Ödeme (Genel Toplam) -->
                                            <tr class="table-primary border-top-2 border-2">
                                                <td>
                                                    <strong>= ÜRETİCİLERE NET ÖDEME (GENEL TOPLAM)</strong>
                                                    <br>
                                                    <small class="text-muted">Ödenecek toplam tutar</small>
                                                </td>
                                                <td class="text-end">
                                                    <h6 class="mb-0 text-primary fw-bold">₺{{ total_payments_to_producers|floatformat:2 }}</h6>
                                                </td>
                                            </tr>

                                            <!-- İstatistik Satırı -->
                                            <tr class="table-light mt-3">
                                                <td colspan="2">
                                                    <div class="row g-2 small">
                                                        <div class="col-auto">
                                                            <span class="badge bg-secondary">
                                                                Aktif Üretici: {{ producers_payment_summary|length }}
                                                            </span>
                                                        </div>
                                                        <div class="col-auto">
                                                            <span class="badge bg-info">
                                                                Ödenen: {{ paid_producers_count|default:0 }}
                                                            </span>
                                                        </div>
                                                        <div class="col-auto">
                                                            <span class="badge bg-warning">
                                                                Bekleyen: {{ pending_producers_count|default:0 }}
                                                            </span>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="alert alert-info mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            Bu dönemde ödemesi gereken üretici merkez bulunmamaktadır.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Fatura Durumları -->
    <div class="row mt-4">
        <div class="col-md-6 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0">
                    <h6 class="mb-0 fw-bold">
                        <i class="fas fa-file-invoice me-2 text-success"></i>
                        İşitme Merkezi Faturaları
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-6">
                            <div class="text-center p-3 bg-light rounded">
                                <h5 class="mb-1">{{ center_invoice_stats.total }}</h5>
                                <small class="text-muted">Toplam</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center p-3 bg-success bg-opacity-10 rounded">
                                <h5 class="mb-1 text-success">{{ center_invoice_stats.paid }}</h5>
                                <small class="text-muted">Ödendi</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center p-3 bg-warning bg-opacity-10 rounded">
                                <h5 class="mb-1 text-warning">{{ center_invoice_stats.pending }}</h5>
                                <small class="text-muted">Bekliyor</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center p-3 bg-primary bg-opacity-10 rounded">
                                <h5 class="mb-1 text-primary">₺{{ center_invoice_stats.total_amount|floatformat:0 }}</h5>
                                <small class="text-muted">Toplam Tutar</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Üretici Fatura İstatistikleri - DISABLED (Fatura sadece işitme merkezlerine kesilir) -->
    </div>

    <!-- Quick Actions -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="mb-3 fw-bold">
                        <i class="fas fa-bolt me-2 text-warning"></i>
                        Hızlı İşlemler
                    </h6>
                    <div class="btn-group" role="group">
                        <a href="{% url 'core:invoice_list' %}" class="btn btn-outline-primary">
                            <i class="fas fa-list me-1"></i>Tüm Faturalar
                        </a>
                        <a href="{% url 'core:moldpark_collections_report' %}" class="btn btn-outline-info">
                            <i class="fas fa-chart-bar me-1"></i>Detaylı Rapor
                        </a>
                        <a href="{% url 'core:financial_dashboard' %}" class="btn btn-outline-success">
                            <i class="fas fa-tachometer-alt me-1"></i>Finansal Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Ödeme Bilgilendirme Modal -->
<div class="modal fade" id="paymentNotificationModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-envelope me-2 text-info"></i>
                    Ödeme Bilgilendirmesi Gönder
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="paymentNotificationForm">
                    <div class="mb-3">
                        <label class="form-label">Üretici Merkez</label>
                        <input type="text" class="form-control" id="producerName" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ödeme Tutarı</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="paymentAmount" readonly>
                            <span class="input-group-text">₺</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ödeme Tarihi</label>
                        <input type="date" class="form-control" id="paymentDate" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ödeme Yöntemi</label>
                        <select class="form-select" id="paymentMethod" required>
                            <option value="">Seçiniz...</option>
                            <option value="Banka Transferi">Banka Transferi</option>
                            <option value="EFT">EFT</option>
                            <option value="Çek">Çek</option>
                            <option value="Nakit">Nakit</option>
                            <option value="Diğer">Diğer</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Açıklama (İsteğe Bağlı)</label>
                        <textarea class="form-control" id="paymentNotes" rows="3" placeholder="Ödeme ile ilgili notlar..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-info" onclick="sendPaymentNotification()">
                    <i class="fas fa-paper-plane me-1"></i>Gönder
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// İşitme merkezlerine toplu fatura kesme
function createSingleCenterInvoice(centerId, centerName) {
    if (!confirm(`"${centerName}" merkezine fatura kesilecek ve e-posta gönderilecek. Onaylıyor musunuz?`)) {
        return;
    }
    
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Kesiliyor...';
    
    fetch(`/admin/financial-control/create-center-invoice/${centerId}/?period={{ period }}`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Başarılı!\n\nFatura Kesildi:\n` +
                  `Merkez: ${data.center_name}\n` +
                  `Fatura No: ${data.invoice_number}\n` +
                  `Fiziksel Kalıp: ${data.physical_count} adet\n` +
                  `3D Modelleme: ${data.digital_count} adet\n` +
                  `Aylık Ücret: ₺${data.monthly_fee}\n` +
                  `Toplam: ₺${data.total_amount}`);
            window.location.reload();
        } else {
            alert('Hata: ' + (data.error || 'Bilinmeyen bir hata oluştu'));
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Fatura kesilirken bir hata oluştu: ' + error);
        btn.disabled = false;
        btn.innerHTML = originalText;
    });
}

function bulkCreateCenterInvoices() {
    if (!confirm('Tüm işitme merkezlerine fatura kesilecek ve e-posta gönderilecek. Onaylıyor musunuz?')) {
        return;
    }
    
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Faturalar kesiliyor...';
    
    fetch('{% url "core:bulk_create_center_invoices" %}?period={{ period }}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Başarılı!\n\n${data.created_count} adet fatura kesildi ve gönderildi.\nToplam tutar: ₺${data.total_amount}`);
            window.location.reload();
        } else {
            alert('Hata: ' + (data.error || 'Bilinmeyen bir hata oluştu'));
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Faturalar kesilirken bir hata oluştu: ' + error);
        btn.disabled = false;
        btn.innerHTML = originalText;
    });
}

// Üretici Ödeme Bilgilendirmesi Modal'ı Aç
function showPaymentNotificationModal(producerId, producerName, paymentAmount) {
    document.getElementById('producerName').value = producerName;
    document.getElementById('paymentAmount').value = parseFloat(paymentAmount).toFixed(2);
    document.getElementById('paymentDate').valueAsDate = new Date();
    document.getElementById('paymentMethod').value = '';
    document.getElementById('paymentNotes').value = '';
    
    // Modal'ı aç
    const modal = new bootstrap.Modal(document.getElementById('paymentNotificationModal'));
    modal.show();
    
    // Producer ID'sini data attribute'e kaydet
    document.getElementById('paymentNotificationForm').dataset.producerId = producerId;
}

// Ödeme Bilgilendirmesi Gönder
function sendPaymentNotification() {
    const form = document.getElementById('paymentNotificationForm');
    const producerId = form.dataset.producerId;
    const paymentDate = document.getElementById('paymentDate').value;
    const paymentMethod = document.getElementById('paymentMethod').value;
    const paymentNotes = document.getElementById('paymentNotes').value;
    
    if (!paymentDate || !paymentMethod) {
        alert('Lütfen zorunlu alanları doldurunuz!');
        return;
    }
    
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Gönderiliyor...';
    
    fetch(`/admin/financial-control/send-payment-notification/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            producer_id: producerId,
            payment_date: paymentDate,
            payment_method: paymentMethod,
            notes: paymentNotes,
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✓ Ödeme bilgilendirmesi başarıyla gönderildi!');
            bootstrap.Modal.getInstance(document.getElementById('paymentNotificationModal')).hide();
            location.reload();
        } else {
            alert('✗ Hata: ' + (data.message || data.error || 'Bir hata oluştu'));
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('✗ Bilgilendirme gönderirken bir hata oluştu: ' + error);
        btn.disabled = false;
        btn.innerHTML = originalText;
    });
}

// Üretici Ödemesini Ödendi Olarak İşaretle
function markProducerAsPaid(producerId, producerName) {
    if (!confirm(`"${producerName}" için ödemenin gerçekleştirildiğini onaylamak istediğinize emin misiniz?`)) {
        return;
    }
    
    fetch(`/admin/financial-control/mark-producer-paid/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            producer_id: producerId,
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✓ Ödeme başarıyla onaylandı! Üretici merkezine "Ödeme Onaylandı" bildirimi gönderildi.');
            location.reload();
        } else {
            alert('✗ Hata: ' + (data.message || data.error || 'Bir hata oluştu'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('✗ Ödeme onaylanırken bir hata oluştu: ' + error);
    });
}

// Tooltip'leri aktif hale getir
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}

