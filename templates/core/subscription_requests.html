{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Abonelik Talepleri - MoldPark Admin{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-6">
            <h2><i class="fas fa-clipboard-check me-2"></i>Abonelik Talepleri</h2>
        </div>
        <div class="col-md-6 text-end">
            <a href="{% url 'core:financial_dashboard' %}" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left me-1"></i>Dashboard'a Dön
            </a>
        </div>
    </div>

    <!-- İstatistik Kartları -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center border-warning">
                <div class="card-body">
                    <h5 class="card-title text-warning">Bekleyen</h5>
                    <h3 class="text-warning">{{ pending_count }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-success">
                <div class="card-body">
                    <h5 class="card-title text-success">Onaylanan</h5>
                    <h3 class="text-success">{{ approved_count }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-danger">
                <div class="card-body">
                    <h5 class="card-title text-danger">Reddedilen</h5>
                    <h3 class="text-danger">{{ rejected_count }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-primary">
                <div class="card-body">
                    <h5 class="card-title text-primary">Toplam</h5>
                    <h3 class="text-primary">{{ total_count }}</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtreler -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Durum</label>
                    <select name="status" class="form-select" onchange="this.form.submit()">
                        <option value="all" {% if status_filter == 'all' %}selected{% endif %}>Tümü</option>
                        <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Bekleyen</option>
                        <option value="approved" {% if status_filter == 'approved' %}selected{% endif %}>Onaylanan</option>
                        <option value="rejected" {% if status_filter == 'rejected' %}selected{% endif %}>Reddedilen</option>
                    </select>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <a href="{% url 'core:subscription_requests' %}" class="btn btn-secondary w-100">
                        <i class="fas fa-redo me-1"></i>Filtreleri Temizle
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Talep Listesi -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Merkez Adı</th>
                            <th>Kullanıcı</th>
                            <th>Plan</th>
                            <th>Talep Tarihi</th>
                            <th>Durum</th>
                            <th>İşlemler</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for request in requests %}
                        <tr>
                            <td>
                                {% if request.user.center %}
                                    <strong>{{ request.user.center.name }}</strong>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {{ request.user.get_full_name|default:request.user.username }}<br>
                                <small class="text-muted">{{ request.user.email }}</small>
                            </td>
                            <td>
                                <span class="badge bg-info">{{ request.plan.name }}</span>
                            </td>
                            <td>{{ request.created_at|date:"d.m.Y H:i" }}</td>
                            <td>
                                {% if request.status == 'pending' %}
                                    <span class="badge bg-warning">Bekliyor</span>
                                {% elif request.status == 'approved' %}
                                    <span class="badge bg-success">Onaylandı</span>
                                {% else %}
                                    <span class="badge bg-danger">Reddedildi</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    {% if request.status == 'pending' %}
                                        <button onclick="approveRequest({{ request.id }}, '{{ request.user.center.name }}')" 
                                                class="btn btn-success" title="Onayla">
                                            <i class="fas fa-check"></i> Onayla
                                        </button>
                                        <button onclick="rejectRequest({{ request.id }}, '{{ request.user.center.name }}')" 
                                                class="btn btn-danger" title="Reddet">
                                            <i class="fas fa-times"></i> Reddet
                                        </button>
                                    {% else %}
                                        <span class="badge bg-secondary">
                                            {{ request.processed_at|date:"d.m.Y" }}
                                        </span>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center text-muted py-4">
                                <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                                Henüz abonelik talebi bulunmuyor
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
function approveRequest(requestId, centerName) {
    if (!confirm(`${centerName} adlı merkezin abonelik talebini onaylamak istediğinize emin misiniz?`)) {
        return;
    }
    
    fetch(`/admin/subscription-requests/${requestId}/approve/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✓ ' + data.message);
            location.reload();
        } else {
            alert('✗ Hata: ' + data.error);
        }
    })
    .catch(error => {
        alert('✗ Bir hata oluştu: ' + error);
    });
}

function rejectRequest(requestId, centerName) {
    const reason = prompt(`${centerName} adlı merkezin abonelik talebini reddetme sebebi:`);
    if (!reason) {
        return;
    }
    
    fetch(`/admin/subscription-requests/${requestId}/reject/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ reason: reason })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✓ ' + data.message);
            location.reload();
        } else {
            alert('✗ Hata: ' + data.error);
        }
    })
    .catch(error => {
        alert('✗ Bir hata oluştu: ' + error);
    });
}
</script>
{% endblock %}
