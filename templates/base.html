{% load i18n %}
{% load static %}
{% load moldpark_extras %}
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <meta name="csrf-token" content="{{ csrf_token }}">
    
    <!-- SEO ve Meta Tag'ler -->
    <meta name="description" content="{% block description %}MoldPark - TÃ¼rkiye'nin en geliÅŸmiÅŸ kulak kalÄ±bÄ± Ã¼retim ve yÃ¶netim sistemi. Ä°ÅŸitme merkezleri ve Ã¼retici merkezler iÃ§in profesyonel Ã§Ã¶zÃ¼mler.{% endblock %}">
    <meta name="keywords" content="{% block keywords %}kulak kalÄ±bÄ±, iÅŸitme cihazÄ±, kalÄ±p Ã¼retimi, moldpark, iÅŸitme merkezi, kulak kalÄ±bÄ± Ã¼retimi{% endblock %}">
    <meta name="author" content="MoldPark">
    <meta name="robots" content="{% block robots %}index, follow{% endblock %}">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="{% block og_url %}{{ request.build_absolute_uri }}{% endblock %}">
    <meta property="og:title" content="{% block og_title %}MoldPark - Kulak KalÄ±bÄ± YÃ¶netim Sistemi{% endblock %}">
    <meta property="og:description" content="{% block og_description %}MoldPark ile kulak kalÄ±bÄ± Ã¼retim sÃ¼recinizi dijitalleÅŸtirin. Ä°ÅŸitme merkezleri ve Ã¼retici merkezler iÃ§in tasarlanmÄ±ÅŸ modern yÃ¶netim sistemi.{% endblock %}">
    <meta property="og:image" content="{% block og_image %}{% static 'images/moldpark_logo.jpg' %}{% endblock %}">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="{% block twitter_url %}{{ request.build_absolute_uri }}{% endblock %}">
    <meta property="twitter:title" content="{% block twitter_title %}MoldPark - Kulak KalÄ±bÄ± YÃ¶netim Sistemi{% endblock %}">
    <meta property="twitter:description" content="{% block twitter_description %}MoldPark ile kulak kalÄ±bÄ± Ã¼retim sÃ¼recinizi dijitalleÅŸtirin. Profesyonel Ã§Ã¶zÃ¼mler.{% endblock %}">
    <meta property="twitter:image" content="{% block twitter_image %}{% static 'images/moldpark_logo.jpg' %}{% endblock %}">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="{% block canonical %}{{ request.build_absolute_uri }}{% endblock %}">
    
    <title>{% block title %}MoldPark - Kulak KalÄ±bÄ± YÃ¶netim Sistemi{% endblock %}</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{% static 'favicon.ico' %}">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="{% static 'css/custom.css' %}?v=4.1" rel="stylesheet">
    
    <!-- Navbar Modern CSS -->
    <style>
        /* TÃ¼m sayfa arka planÄ± */
        body {
            background: #FFD15C !important;
            min-height: 100vh;
        }
        
        .content-wrapper {
            background: #FFD15C;
        }
        
        .navbar-modern {
            background: #FFD15C !important;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .navbar-modern .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            color: #000000 !important;
            text-shadow: none;
        }
        
        .navbar-modern .navbar-nav .nav-link {
            color: #000000 !important;
            font-weight: 500;
            font-size: 0.95rem;
            padding: 0.75rem 1rem;
            margin: 0 0.25rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .navbar-modern .navbar-nav .nav-link:hover {
            color: #000000 !important;
            background: rgba(0, 0, 0, 0.05);
            transform: translateY(-1px);
        }
        
        .navbar-modern .navbar-nav .nav-link.active {
            background: rgba(0, 0, 0, 0.1);
            color: #000000 !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .navbar-modern .btn-primary {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            border: none;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            transition: all 0.3s ease;
        }
        
        .navbar-modern .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.6);
        }
        
        .navbar-modern .btn-success {
            background: linear-gradient(135deg, #00d2ff, #3a7bd5);
            border: none;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0, 210, 255, 0.4);
        }
        
        .notification-badge {
            position: relative;
            top: -8px;
            right: -6px;
            font-size: 0.6rem;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .dropdown-menu-modern {
            border: none;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            border-radius: 16px;
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }
        
        .brand-logo {
            transition: all 0.3s ease;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.2));
        }
        
        .brand-logo:hover {
            transform: scale(1.05);
        }
        
        .navbar-shadow {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(10px);
        }
        
        .user-dropdown-modern {
            width: 280px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        }
        
        .nav-item-divider {
            height: 1px;
            background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.2), transparent);
            margin: 0.5rem 0;
        }
        
        .mobile-user-header-modern {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 12px;
            margin: 1rem;
            padding: 1rem;
            color: #000000;
        }
        
        .language-switcher-modern .dropdown-item {
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin: 0.25rem;
            transition: all 0.3s ease;
        }
        
        .language-switcher-modern .dropdown-item:hover {
            background: rgba(0, 0, 0, 0.05);
            transform: translateX(2px);
        }
        
        .language-switcher-modern .dropdown-item.active {
            background: rgba(0, 0, 0, 0.1);
            color: #000000;
        }
        
        /* Navbar icon ve badge renkleri */
        .navbar-modern .navbar-nav .nav-link i,
        .navbar-modern .navbar-nav .nav-link .fas,
        .navbar-modern .navbar-nav .nav-link .fa {
            color: #000000 !important;
        }
        
        .navbar-modern .dropdown-toggle::after {
            border-top-color: #000000;
        }
        
        /* Navbar toggler icon */
        .navbar-modern .navbar-toggler {
            border-color: rgba(0, 0, 0, 0.2);
        }
        
        .navbar-modern .navbar-toggler-icon {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba%280, 0, 0, 0.85%29' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
        }
        
        /* Mobile quick actions butonlarÄ± */
        .navbar-modern .btn-link {
            color: #000000 !important;
        }
        
        .navbar-modern .btn-link:hover {
            color: #000000 !important;
            opacity: 0.7;
        }
        
        /* Dropdown menÃ¼ renkleri */
        .navbar-modern .dropdown-menu {
            background: #FFD15C;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .navbar-modern .dropdown-item {
            color: #000000;
        }
        
        .navbar-modern .dropdown-item:hover {
            background: rgba(0, 0, 0, 0.1);
            color: #000000;
        }
        
        .navbar-modern .dropdown-header {
            color: #000000;
            font-weight: 600;
        }
        
        /* Badge renkleri navbar iÃ§inde */
        .navbar-modern .badge {
            color: white;
        }
        
        /* Dropdown iÃ§indeki text renkleri */
        .navbar-modern .dropdown-menu .text-muted {
            color: #666666 !important;
        }
        
        .navbar-modern .dropdown-menu .text-primary {
            color: #000000 !important;
        }
        
        .navbar-modern .dropdown-menu .text-success {
            color: #28a745 !important;
        }
        
        .navbar-modern .dropdown-menu .bg-light {
            background-color: rgba(0, 0, 0, 0.05) !important;
        }
        
        .navbar-modern .dropdown-menu hr {
            border-color: rgba(0, 0, 0, 0.1);
        }
        
        /* User dropdown icon */
        .navbar-modern .fa-user-circle {
            color: #000000 !important;
        }
        
        /* Dropdown iÃ§indeki icon'lar */
        .navbar-modern .dropdown-menu .fas,
        .navbar-modern .dropdown-menu .fa {
            color: #000000;
        }
        
        /* Responsive improvements */
        @media (max-width: 991.98px) {
            .navbar-modern {
                background: #FFD15C !important;
            }
            
            .navbar-modern .navbar-nav .nav-link {
                margin: 0.25rem 0;
                text-align: center;
                border-radius: 8px;
            }
            
            .dropdown-menu-modern {
                width: 100%;
                margin: 0.5rem 0;
            }
        }
    </style>
    
    {% block extra_css %}{% endblock %}
    
    <!-- Accessibility ve Tema Rengi -->
    <meta name="theme-color" content="#F5B427" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#1e1b4b" media="(prefers-color-scheme: dark)">
    <meta name="color-scheme" content="light dark">
</head>
<body>
    <!-- Skip Navigation Link for Accessibility -->
    <a href="#main-content" class="visually-hidden-focusable skip-link position-absolute top-0 start-0 z-3 btn btn-primary">
        Ana iÃ§eriÄŸe geÃ§
    </a>
    
    <!-- Modern Navbar -->
        <nav class="navbar navbar-expand-lg navbar-light navbar-modern" role="navigation" aria-label="Ana navigasyon">
        <div class="container">
            <!-- Logo -->
            <a class="navbar-brand d-flex align-items-center" href="{% if user.is_authenticated %}{% url 'accounts:smart_home_redirect' %}{% else %}{% url 'core:home' %}{% endif %}" title="{% if user.is_authenticated %}Dashboard{% else %}Ana Sayfa{% endif %}">
                <img src="{% static 'images/moldpark_logo.jpg' %}" alt="MoldPark Logo" 
                     class="me-2 brand-logo shadow-lg" 
                     style="width: 120px; height: 50px; object-fit: contain; border-radius: 8px;">
            </a>
            
            <!-- Mobile Quick Actions -->
            <div class="d-flex d-lg-none align-items-center gap-2">
                {% if user.is_authenticated %}
                    <!-- Yeni KalÄ±p butonu (sadece iÅŸitme merkezleri iÃ§in, Ã¼retici merkezler gÃ¶rmesin) -->
                    {% if user.center and not user.producer %}
                        <a href="{% url 'mold:mold_create' %}" class="btn btn-primary btn-sm">
                            <i class="fas fa-plus"></i>
                        </a>
                    {% endif %}
                    
                    <!-- Bildirimler (mobile) -->
                    <div class="dropdown">
                        <button class="btn btn-link p-1" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-bell"></i>
                            {% if unread_notifications > 0 %}
                                <span class="position-absolute translate-middle badge rounded-pill bg-danger" style="top: 8px; left: 20px; font-size: 0.6rem;">
                                    {{ unread_notifications }}
                                </span>
                            {% endif %}
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li class="dropdown-header">Bildirimler</li>
                            <li><a class="dropdown-item" href="{% url 'core:simple_notifications' %}">TÃ¼m Bildirimler</a></li>
                        </ul>
                    </div>
                {% endif %}
            </div>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <!-- Mobile User Header -->
                <div class="d-lg-none border-bottom pb-3 mb-3 mt-3 mobile-user-header-modern">
                    {% if user.is_authenticated %}
                        <div class="d-flex align-items-center">
                            <i class="fas fa-user-circle fs-2 me-3" style="color: #000000;"></i>
                            <div>
                                <div class="fw-bold">
                                    {% if user.producer %}
                                        {{ user.producer.company_name }}
                                    {% elif user.center %}
                                        {{ user.center.name }}
                                    {% else %}
                                        {{ user.username }}
                                    {% endif %}
                                </div>
                                <small style="color: #666666;">
                                    {% if user.producer %}Ãœretici Merkez
                                    {% elif user.center %}Ä°ÅŸitme Merkezi
                                    {% elif user.is_staff %}Sistem YÃ¶neticisi
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                    {% endif %}
                </div>
                
                <!-- Producer Navigation -->
                {% if user.is_authenticated and user.producer %}
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'producer:dashboard' %}">
                                <i class="fas fa-home me-1"></i>Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {% if 'mold' in request.resolver_match.url_name %}active{% endif %}" 
                               href="{% url 'producer:mold_list' %}">
                                <i class="fas fa-cube me-1"></i>KalÄ±plar
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'producer:revision_requests' %}">
                                <i class="fas fa-edit me-1"></i>Revizyonlar
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {% if 'message' in request.resolver_match.url_name %}active{% endif %}" 
                               href="{% url 'core:message_list' %}" onclick="clearMessageBadges()">
                                <i class="fas fa-envelope me-1"></i>Mesajlar
                                {% if unread_message_count > 0 %}
                                    <span class="badge bg-danger ms-1 message-badge">{{ unread_message_count }}</span>
                                {% endif %}
                            </a>
                        </li>
                    </ul>
                {% endif %}
                
                <ul class="navbar-nav">
                    {% if not user.is_authenticated %}
                        <!-- Misafir -->
                        <li class="nav-item"><a class="nav-link" href="{% url 'core:pricing' %}">{% trans "FiyatlandÄ±rma" %}</a></li>
                        <li class="nav-item"><a class="nav-link" href="{% url 'core:help_center' %}">{% trans "YardÄ±m Merkezi" %}</a></li>
                    {% else %}
                        {% if user.is_staff %}
                            <!-- Admin -->
                            <li class="nav-item"><a class="nav-link" href="{% url 'core:admin_dashboard' %}"><i class="fas fa-tachometer-alt me-1"></i>{% trans "Dashboard" %}</a></li>
                            <li class="nav-item"><a class="nav-link {% if 'message' in request.resolver_match.url_name %}active{% endif %}" href="{% url 'core:message_list' %}" onclick="clearMessageBadges()"><i class="fas fa-envelope me-1"></i>{% trans "Mesajlar" %}{% if unread_message_count > 0 %}<span class="badge bg-danger ms-1 message-badge">{{ unread_message_count }}</span>{% endif %}</a></li>
                        {% elif user.producer %}
                            <!-- Ãœretici - Sol menÃ¼ zaten var, burada tekrarlama -->
                        {% else %}
                            <!-- Ä°ÅŸitme Merkezi -->
                            <li class="nav-item"><a class="nav-link" href="{% url 'center:dashboard' %}"><i class="fas fa-home me-1"></i>{% trans "Dashboard" %}</a></li>
                            <li class="nav-item"><a class="nav-link" href="{% url 'center:my_usage' %}"><i class="fas fa-chart-line me-1"></i>{% trans "KullanÄ±mlarÄ±m" %}</a></li>
                            <li class="nav-item"><a class="nav-link" href="{% url 'mold:mold_list' %}"><i class="fas fa-cube me-1"></i>{% trans "KalÄ±plarÄ±m" %}</a></li>
                            <li class="nav-item"><a class="nav-link {% if 'message' in request.resolver_match.url_name %}active{% endif %}" href="{% url 'core:message_list' %}" onclick="clearMessageBadges()"><i class="fas fa-envelope me-1"></i>{% trans "Mesajlar" %}{% if unread_message_count > 0 %}<span class="badge bg-danger ms-1 message-badge">{{ unread_message_count }}</span>{% endif %}</a></li>
                        {% endif %}
                        <!-- Bildirimler -->
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle position-relative" href="#" id="notificationDropdown" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-bell me-1"></i>{% trans "Bildirimler" %}
                                {% if unread_notifications > 0 %}<span class="badge bg-danger ms-1 notification-badge">{{ unread_notifications }}</span>{% endif %}
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end dropdown-menu-modern shadow-lg" style="width: 320px; max-height: 400px; overflow-y: auto;">
                                <li class="dropdown-header d-flex justify-content-between align-items-center">
                                    <span>{% trans "Bildirimler" %}</span>
                                    {% if unread_notifications > 0 %}<span class="badge bg-primary">{{ unread_notifications }}</span>{% endif %}
                                </li>
                                {% if unread_notifications > 0 %}
                                    <li><button class="dropdown-item text-success" onclick="markAllNotificationsReadFromDropdown()" type="button"><i class="fas fa-check-double me-2"></i>{% trans "TÃ¼mÃ¼nÃ¼ okundu iÅŸaretle" %}</button></li>
                                    <li><hr class="dropdown-divider"></li>
                                {% endif %}
                                {% for notification in user.simple_notifications.all|slice:":4" %}
                                    <li>
                                        <a class="dropdown-item py-2 {% if not notification.is_read %}bg-light{% endif %}" href="{% url 'core:notification_redirect' notification.id %}">
                                            <div class="d-flex align-items-start">
                                                <i class="{{ notification.get_icon }} text-{{ notification.get_color }} me-2 mt-1 fs-6"></i>
                                                <div class="flex-grow-1">
                                                    <div class="fw-semibold small">{{ notification.title|truncatechars:25 }}</div>
                                                    <small class="text-muted">{{ notification.message|truncatechars:40 }}</small>
                                                    <div class="text-muted" style="font-size: 0.65rem;">{{ notification.created_at|timesince }} Ã¶nce {% if not notification.is_read %}<span class="text-primary">â€¢ Yeni</span>{% endif %}</div>
                                                </div>
                                            </div>
                                        </a>
                                    </li>
                                {% empty %}
                                    <li><div class="dropdown-item-text text-center text-muted py-3"><i class="fas fa-bell-slash mb-2"></i><br><small>HenÃ¼z bildirim yok</small></div></li>
                                {% endfor %}
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-center text-primary small" href="{% url 'core:simple_notifications' %}">TÃ¼mÃ¼nÃ¼ gÃ¶rÃ¼ntÃ¼le</a></li>
                            </ul>
                        </li>
                    {% endif %}
                </ul>
                
                <!-- SaÄŸ taraf - Yeni KalÄ±p butonu ve KullanÄ±cÄ± menÃ¼sÃ¼ -->
                <ul class="navbar-nav">
                    <!-- Language Switcher -->
                    <li class="nav-item dropdown me-2">
                        <a class="nav-link dropdown-toggle" href="#" id="languageDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-globe me-1"></i>
                            {% get_current_language as LANGUAGE_CODE %}
                            {% if LANGUAGE_CODE == 'tr' %}ðŸ‡¹ðŸ‡· TR{% elif LANGUAGE_CODE == 'en' %}ðŸ‡ºðŸ‡¸ EN{% else %}{{ LANGUAGE_CODE|upper }}{% endif %}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end dropdown-menu-modern language-switcher-modern shadow-lg border-0" aria-labelledby="languageDropdown">
                            {% get_available_languages as LANGUAGES %}
                            {% get_language_info_list for LANGUAGES as languages %}
                            <!-- Debug: Current language: {{ LANGUAGE_CODE }} -->
                            {% for language in languages %}
                                <li>
                                    <!-- Debug: Language: {{ language.code }} - {{ language.name_local }} -->
                                    <form action="{% url 'set_language' %}" method="post" style="display: inline;" onsubmit="return validateLanguageForm(this);">
                                        {% csrf_token %}
                                        <input name="next" type="hidden" value="{{ request.get_full_path }}" />
                                        <input name="language" type="hidden" value="{{ language.code }}" />
                                        <button type="submit" class="dropdown-item {% if language.code == LANGUAGE_CODE %}active{% endif %}">
                                            {% if language.code == 'tr' %}ðŸ‡¹ðŸ‡· TÃ¼rkÃ§e{% elif language.code == 'en' %}ðŸ‡ºðŸ‡¸ English{% else %}{{ language.name_local|title }}{% endif %}
                                        </button>
                                    </form>
                                </li>
                            {% endfor %}
                        </ul>
                    </li>
                    
                    {% if user.is_authenticated %}
                        <!-- Yeni KalÄ±p butonu (sadece normal iÅŸitme merkezleri iÃ§in, admin ve Ã¼retici merkezler gÃ¶rmesin) -->
                        {% if user.is_superuser %}
                            <li class="nav-item me-2">
                                <a class="btn btn-success" href="{% url 'core:financial_dashboard' %}">
                                    <i class="fas fa-chart-line me-1"></i>Finansal Dashboard
                                </a>
                            </li>
                        {% endif %}
                        {% if user.center and not user.producer and not user.is_staff and not user.is_superuser %}
                            <li class="nav-item me-2">
                                <a class="btn btn-primary" href="{% url 'mold:mold_create' %}">
                                    <i class="fas fa-plus me-1"></i>Yeni KalÄ±p
                                </a>
                            </li>
                        {% endif %}
                        
                        <!-- KullanÄ±cÄ± dropdown menÃ¼sÃ¼ -->
                        <li class="nav-item dropdown">
                            <a class="nav-link d-flex align-items-center" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-user-circle fs-5"></i>
                                <span class="d-none d-md-inline ms-2">
                                    {% if user.producer %}
                                        {{ user.producer.company_name|truncatechars:15 }}
                                    {% elif user.center %}
                                        {{ user.center.name|truncatechars:15 }}
                                    {% else %}
                                        {{ user.username }}
                                    {% endif %}
                                </span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end user-dropdown-modern">
                                <li class="dropdown-header">
                                    <small class="text-muted">
                                        {% if user.producer %}Ãœretici Merkez{% elif user.center %}Ä°ÅŸitme Merkezi{% elif user.is_staff %}Sistem YÃ¶neticisi{% endif %}
                                    </small>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                
                                {% if user.producer %}
                                    <li><a class="dropdown-item" href="{% url 'producer:dashboard' %}"><i class="fas fa-home me-2"></i>{% trans "Dashboard" %}</a></li>
                                    <li><a class="dropdown-item" href="{% url 'producer:profile' %}"><i class="fas fa-user me-2"></i>{% trans "Profil AyarlarÄ±" %}</a></li>
                                    <li><a class="dropdown-item" href="{% url 'producer:network_list' %}"><i class="fas fa-network-wired me-2"></i>{% trans "AÄŸ YÃ¶netimi" %}</a></li>
                                {% elif user.center %}
                                    <li><a class="dropdown-item" href="{% url 'center:dashboard' %}"><i class="fas fa-home me-2"></i>{% trans "Dashboard" %}</a></li>
                                    <li><a class="dropdown-item" href="{% url 'center:profile' %}"><i class="fas fa-user me-2"></i>{% trans "Profil AyarlarÄ±" %}</a></li>
                                    <li><a class="dropdown-item" href="{% url 'core:subscription_dashboard' %}"><i class="fas fa-credit-card me-2"></i>{% trans "Abonelik" %}</a></li>
                                {% elif user.is_staff %}
                                    <li><a class="dropdown-item" href="{% url 'core:admin_dashboard' %}"><i class="fas fa-tachometer-alt me-2"></i>{% trans "Admin Dashboard" %}</a></li>
                                    <li><a class="dropdown-item" href="{% url 'core:admin_financial_control_panel' %}"><i class="fas fa-chart-line me-2"></i>{% trans "Finansal Kontrol" %}</a></li>
                                    <li><a class="dropdown-item" href="/admin/" target="_blank"><i class="fas fa-cog me-2"></i>{% trans "Django Admin Paneli" %}</a></li>
                                {% endif %}
                                
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="{% url 'core:help_center' %}"><i class="fas fa-question-circle me-2"></i>{% trans "YardÄ±m Merkezi" %}</a></li>
                                <li><hr class="dropdown-divider"></li>
                                
                                {% if user.producer %}
                                    <li><a class="dropdown-item text-danger" href="{% url 'producer:logout' %}"><i class="fas fa-sign-out-alt me-2"></i>{% trans "Ã‡Ä±kÄ±ÅŸ Yap" %}</a></li>
                                {% else %}
                                    <li><a class="dropdown-item text-danger" href="{% url 'account_logout' %}"><i class="fas fa-sign-out-alt me-2"></i>{% trans "Ã‡Ä±kÄ±ÅŸ Yap" %}</a></li>
                                {% endif %}
                            </ul>
                        </li>
                    {% else %}
                        <!-- Misafir kullanÄ±cÄ±lar iÃ§in kayÄ±t ve giriÅŸ -->
                        <li class="nav-item me-2">
                            <div class="dropdown">
                                <button class="btn btn-outline-dark dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-user-plus me-1"></i>{% trans "KayÄ±t Ol" %}
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0">
                                    <li>
                                        <a class="dropdown-item py-3" href="{% url 'account_signup' %}">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-clinic-medical me-3 text-primary fs-5"></i>
                                                <div>
                                                    <div class="fw-semibold">{% trans "Ä°ÅŸitme Merkezi" %}</div>
                                                    <small class="text-muted">{% trans "KalÄ±p sipariÅŸi vermek iÃ§in" %}</small>
                                                </div>
                                            </div>
                                        </a>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <a class="dropdown-item py-3" href="{% url 'producer:register' %}">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-industry me-3 text-success fs-5"></i>
                                                <div>
                                                    <div class="fw-semibold">{% trans "Ãœretici Merkez" %}</div>
                                                    <small class="text-muted">{% trans "KalÄ±p Ã¼retimi yapmak iÃ§in" %}</small>
                                                </div>
                                            </div>
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </li>
                        <li class="nav-item">
                            <a class="btn btn-dark" href="{% url 'account_login' %}">
                                <i class="fas fa-sign-in-alt me-1"></i>{% trans "GiriÅŸ Yap" %}
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <!-- Navbar Bildirim JavaScript -->
    <script>
    function markAllNotificationsReadFromDropdown() {
        if (confirm('{% trans "TÃ¼m bildirimleri okundu olarak iÅŸaretlemek istediÄŸinizden emin misiniz?" %}')) {
            const csrfToken = getCsrfToken();
            if (!csrfToken) {
                showToast('CSRF token bulunamadÄ±. SayfayÄ± yenileyin.', 'error');
                return;
            }
            
            fetch('/notifications/mark-all-read/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: 'csrfmiddlewaretoken=' + encodeURIComponent(csrfToken)
            })
            .then(response => {
                console.log('Response status:', response.status);
                
                // YanÄ±tÄ±n JSON olup olmadÄ±ÄŸÄ±nÄ± kontrol et
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    console.warn('Response is not JSON:', contentType);
                    return response.text().then(text => {
                        console.log('HTML Response:', text);
                        if (response.ok) {
                            // HTML yanÄ±t alÄ±ndÄ±ysa da baÅŸarÄ±lÄ± kabul et
                            return { success: true, message: 'Ä°ÅŸlem tamamlandÄ±' };
                        }
                        throw new Error('Server returned HTML instead of JSON');
                    });
                }
                
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Navbar'daki tÃ¼m bildirim badge'lerini gÃ¼ncelle
                    const count = data.unread_count || 0;
                    updateNotificationBadges(count);
                    
                    // Dropdown'u kapat
                    const dropdown = bootstrap.Dropdown.getInstance(document.getElementById('notificationDropdown'));
                    if (dropdown) {
                        dropdown.hide();
                    }
                    
                    // BaÅŸarÄ± mesajÄ± gÃ¶ster
                    showToast('TÃ¼m bildirimler okundu olarak iÅŸaretlendi!', 'success');
                    
                    console.log('Updated notification count to:', count);
                    
                    // SayfayÄ± yenile (gÃ¼ncel bildirimler iÃ§in)
                    setTimeout(() => {
                        location.reload();
                    }, 500);
                }
            })
            .catch(error => {
                console.error('Fetch Error:', error);
                showToast('Bir hata oluÅŸtu: ' + error.message, 'error');
            });
        }
    }

    function clearMessageBadges() {
        // Mesaj linkine tÄ±klandÄ±ÄŸÄ±nda badge'leri gizle
        const messageBadges = document.querySelectorAll('.message-badge');
        messageBadges.forEach(badge => {
            badge.style.display = 'none';
        });
    }

        function updateNotificationBadges(count) {
        console.log('updateNotificationBadges called with count:', count);
        
        // Navbar'daki bildirim dropdown badge'ini gÃ¼ncelle
        const notificationLink = document.querySelector('#notificationDropdown');
        if (notificationLink) {
            const existingBadge = notificationLink.querySelector('.badge');
            console.log('Found notification link, existing badge:', existingBadge);
            
            if (count > 0) {
                if (existingBadge) {
                    existingBadge.textContent = count;
                    existingBadge.style.display = 'inline';
                    console.log('Updated existing badge to:', count);
                } else {
                    // Yeni badge oluÅŸtur
                    const newBadge = document.createElement('span');
                    newBadge.className = 'badge bg-danger ms-1';
                    newBadge.textContent = count;
                    notificationLink.appendChild(newBadge);
                    console.log('Created new badge with count:', count);
                }
            } else {
                // Badge'i gizle veya kaldÄ±r
                if (existingBadge) {
                    existingBadge.style.display = 'none';
                    console.log('Hidden existing badge');
                }
            }
        } else {
            console.log('Notification link not found!');
        }

        // Dropdown header'daki badge'i gÃ¼ncelle  
        const dropdownHeaderBadge = document.querySelector('.dropdown-header .badge');
        if (dropdownHeaderBadge) {
            if (count > 0) {
                dropdownHeaderBadge.textContent = count;
                dropdownHeaderBadge.style.display = 'inline';
            } else {
                dropdownHeaderBadge.style.display = 'none';
            }
            console.log('Updated dropdown header badge');
        }
    }

    function showToast(message, type = 'info') {
        // Basit toast mesajÄ± gÃ¶ster
        console.log(`Toast [${type}]: ${message}`);
        
        // EÄŸer bootstrap toast varsa kullan, yoksa alert
        if (typeof bootstrap !== 'undefined' && bootstrap.Toast) {
            // Toast container oluÅŸtur (eÄŸer yoksa)
            let toastContainer = document.querySelector('.toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                document.body.appendChild(toastContainer);
            }
            
            // Toast oluÅŸtur
            const toastHtml = `
                <div class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header">
                        <strong class="me-auto">${type === 'success' ? 'BaÅŸarÄ±lÄ±' : type === 'error' ? 'Hata' : 'Bilgi'}</strong>
                        <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                    </div>
                    <div class="toast-body">${message}</div>
                </div>
            `;
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            
            const toastElement = toastContainer.lastElementChild;
            const toast = new bootstrap.Toast(toastElement);
            toast.show();
            
            // Toast kapandÄ±ktan sonra DOM'dan kaldÄ±r
            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove();
            });
        } else {
            // Fallback: alert kullan
            alert(message);
        }
    }

    function getCsrfToken() {
        try {
            // Form'dan al
            const token = document.querySelector('[name=csrfmiddlewaretoken]');
            if (token && token.value) {
                return token.value;
            }
            
            // Meta tag'den al
            const metaToken = document.querySelector('meta[name="csrf-token"]');
            if (metaToken) {
                return metaToken.getAttribute('content');
            }
            
            // Cookie'den al
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'csrftoken') {
                    return value;
                }
            }
            
            // Script tag'den al (son seÃ§enek)
            const scriptTags = document.querySelectorAll('script');
            for (let script of scriptTags) {
                const content = script.textContent || script.innerText;
                const match = content.match(/csrftoken['"]\s*:\s*['"]([^'"]+)['"]/);
                if (match) {
                    return match[1];
                }
            }
        } catch (error) {
            console.error('Error getting CSRF token:', error);
        }
        
        return '';
    }

    function showToast(message, type = 'info') {
        // Bootstrap toast yoksa basit alert kullan
        if (typeof bootstrap !== 'undefined' && bootstrap.Toast) {
            // Bootstrap toast kodu buraya eklenebilir
            alert(message);
        } else {
            alert(message);
        }
    }

    // Global anchor link koruma sistemi - DOMException hatalarÄ±nÄ± Ã¶nler
    document.addEventListener('DOMContentLoaded', function() {
        // TÃ¼m anchor linkler iÃ§in global koruma
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function(e) {
                const href = this.getAttribute('href');
                
                // BoÅŸ href veya sadece # iÃ§eren linkleri gÃ¼venli ÅŸekilde kontrol et
                if (!href || href === '#' || href.length <= 1) {
                    // Bootstrap dropdown, modal vb. iÃ§in href="#" gerekli olabilir
                    // Bu durumda event'i durdurmuyoruz
                    return;
                }
                
                // GeÃ§erli ID formatÄ±nÄ± kontrol et (HTML5 standartlarÄ±na uygun)
                if (!/^#[a-zA-Z][\w-]*$/.test(href)) {
                    console.warn('Invalid anchor href:', href);
                    e.preventDefault();
                    return;
                }
                
                try {
                    // querySelector'i gÃ¼venli ÅŸekilde kullan
                    const target = document.querySelector(href);
                    if (target) {
                        e.preventDefault();
                        target.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                } catch (error) {
                    console.error('Error in anchor link handler:', error, 'href:', href);
                    e.preventDefault();
                }
            });
        });
    });
    </script>

    <!-- Messages -->
    {% if messages %}
        <div class="container mt-3">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show shadow-sm border-0 rounded-3">
                    <div class="d-flex align-items-center">
                        {% if message.tags == 'success' %}
                            <i class="fas fa-check-circle me-2 text-success"></i>
                        {% elif message.tags == 'error' or message.tags == 'danger' %}
                            <i class="fas fa-exclamation-circle me-2 text-danger"></i>
                        {% elif message.tags == 'warning' %}
                            <i class="fas fa-exclamation-triangle me-2 text-warning"></i>
                        {% else %}
                            <i class="fas fa-info-circle me-2 text-info"></i>
                        {% endif %}
                        <div class="flex-grow-1">{{ message }}</div>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="UyarÄ±yÄ± kapat" title="UyarÄ±yÄ± kapat"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Content -->
    <main id="main-content" class="content-wrapper" role="main">
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="glass-card mt-auto">
        <div class="container py-5">
            <div class="row">
                <div class="col-lg-3 col-md-6 mb-4">
                    <h6 class="fw-bold mb-3">{% trans "Platform" %}</h6>
                    <ul class="list-unstyled">
                        <li class="mb-2"><a href="{% url 'core:pricing' %}" class="text-muted text-decoration-none hover-primary">{% trans "FiyatlandÄ±rma" %}</a></li>
                        <li class="mb-2"><a href="{% url 'core:features' %}" class="text-muted text-decoration-none hover-primary">{% trans "Ã–zellikler" %}</a></li>
                        <li class="mb-2"><a href="{% url 'producer:register' %}" class="text-muted text-decoration-none hover-primary">{% trans "KayÄ±t Ol" %}</a></li>
                    </ul>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <h6 class="fw-bold mb-3">{% trans "Hizmetler" %}</h6>
                    <ul class="list-unstyled">
                        <li class="mb-2"><a href="{% url 'core:features' %}#ai-modeling" class="text-muted text-decoration-none hover-primary">{% trans "AI Modelleme" %}</a></li>
                        <li class="mb-2"><a href="{% url 'core:features' %}#fast-production" class="text-muted text-decoration-none hover-primary">{% trans "HÄ±zlÄ± Ãœretim" %}</a></li>
                        <li class="mb-2"><a href="{% url 'core:features' %}#quality-control" class="text-muted text-decoration-none hover-primary">{% trans "Kalite Kontrol" %}</a></li>
                        <li class="mb-2"><a href="{% url 'core:contact' %}" class="text-muted text-decoration-none hover-primary">{% trans "7/24 Destek" %}</a></li>
                    </ul>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <h6 class="fw-bold mb-3">{% trans "Destek" %}</h6>
                    <ul class="list-unstyled">
                        <li class="mb-2"><a href="{% url 'core:contact' %}" class="text-muted text-decoration-none hover-primary">{% trans "Ä°letiÅŸim" %}</a></li>
                        <li class="mb-2"><a href="{% url 'core:help_center' %}" class="text-muted text-decoration-none hover-primary">{% trans "YardÄ±m Merkezi" %}</a></li>
                        <li class="mb-2"><a href="{% url 'core:documentation' %}" class="text-muted text-decoration-none hover-primary">{% trans "DokÃ¼mantasyon" %}</a></li>
                        <li class="mb-2"><a href="{% url 'core:documentation' %}" class="text-muted text-decoration-none hover-primary">{% trans "API" %}</a></li>
                    </ul>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <h6 class="fw-bold mb-3">{% trans "Ä°letiÅŸim" %}</h6>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <i class="fas fa-envelope me-2 text-primary"></i>
                            <small class="text-muted">info@moldpark.com</small>
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-phone me-2 text-primary"></i>
                            <small class="text-muted">0462 841 41 46 - 0544 221 92 84</small>
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-map-marker-alt me-2 text-primary"></i>
                            <small class="text-muted">VakfÄ±kebir/Trabzon</small>
                        </li>
                    </ul>
                </div>
            </div>
            <hr class="my-4 opacity-25">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <p class="text-muted mb-0">&copy; {% now "Y" %} MoldPark. {% trans "TÃ¼m haklarÄ± saklÄ±dÄ±r." %}</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <small class="text-muted">{% trans "Global gÃ¼venilir kulak kalÄ±bÄ± platformu" %}</small>
                </div>
            </div>
        </div>
    </footer>

    <!-- jQuery -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
    <script src="{% static 'js/custom.js' %}"></script>
    
    <!-- Language Switcher Validation -->
    <script>
        function validateLanguageForm(form) {
            const languageInput = form.querySelector('input[name="language"]');
            const allowedLanguages = ['tr', 'en'];
            
            console.log('Language form submission:', {
                languageValue: languageInput ? languageInput.value : 'undefined',
                formAction: form.action,
                nextValue: form.querySelector('input[name="next"]')?.value
            });
            
            if (!languageInput || !allowedLanguages.includes(languageInput.value)) {
                console.error('Invalid language code:', languageInput ? languageInput.value : 'undefined');
                return false;
            }

            // Otomatik dil yÃ¶nlendirme dÃ¼zeltmesi
            // EÄŸer kullanÄ±cÄ± Ä°ngilizce (/en/...) bir sayfadan TÃ¼rkÃ§e'ye geÃ§mek istiyorsa
            // next parametresindeki '/en/' Ã¶n ekini kaldÄ±r ki LocaleMiddleware yeniden 'en' moduna geÃ§mesin
            if (languageInput.value === 'tr') {
                const nextInput = form.querySelector('input[name="next"]');
                if (nextInput && nextInput.value.startsWith('/en/')) {
                    nextInput.value = nextInput.value.replace(/^\/en\//, '/');
                    console.log('Next path dil Ã¶n eki kaldÄ±rÄ±ldÄ±:', nextInput.value);
                }
            }

            return true;
        }
        
        // Prevent any invalid language submissions
        document.addEventListener('DOMContentLoaded', function() {
            const languageForms = document.querySelectorAll('form[action*="set_language"]');
            languageForms.forEach(form => {
                form.addEventListener('submit', function(e) {
                    if (!validateLanguageForm(this)) {
                        e.preventDefault();
                        console.error('Language form validation failed');
                    }
                });
            });
        });
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html> 